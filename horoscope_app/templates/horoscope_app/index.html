{% load static %}
<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <!-- ★レスポンシブ対応の viewport 指定 -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- SEO用 meta タグ -->
        <meta name="description" content="AI占星術師アオポンによる無料ホロスコープ作成・占いサービス。生年月日、出生時刻、出生地からあなたのホロスコープを作成し、性格、恋愛運、仕事運、金運などを占います。">
        <meta name="keywords" content="ホロスコープ, ホロスコープ作成, 占星術, AI占星術, 性格, 恋愛運, 仕事運, 金運,健康運,学業運">
        <meta name="robots" content="index, follow">
        
        <!-- Canonical タグ（URLが確定している場合） -->
        <link rel="canonical" href="https://aihoroscopeanalysis.com/">

        <!-- OGPタグ（SNS等でのシェア用） -->
        <meta property="og:title" content="無料ホロスコープ作成・占い - AI占星術師アオポン">
        <meta property="og:description" content="生年月日、出生時刻、出生地からあなたのホロスコープを作成し、性格・恋愛運・仕事運・金運を占います。">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://aihoroscopeanalysis.com/">
        <meta property="og:image" content="{% static 'path/to/horoscope-demo6.png' %}">

        <!-- JSON-LDによる構造化データ -->
        <script type="application/ld+json">
        {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "name": "無料ホロスコープ作成・占い - AI占星術師アオポン",
        "description": "生年月日、出生時刻、出生地からあなたのホロスコープを無料で作成し、性格・恋愛運・仕事運・金運・健康運・学業運を占うAI占星術師アオポンのサービスです。",
        "url": "https://aihoroscopeanalysis.com/"
        }
        </script>

        <title>無料ホロスコープ作成・占い - AI占星術師アオポン</title>
        
        <!-- Marked.jsのUMDビルドを読み込む -->
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <!-- DOMPurifyを読み込む（セキュリティ対策） -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.10/purify.min.js"></script>
        
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-V8QL89EXFC"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-V8QL89EXFC');
        </script>

        <script type="text/javascript">
            (function(c,l,a,r,i,t,y){
                c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
                t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
                y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
            })(window, document, "clarity", "script", "q3kqriyub6");
        </script>
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9717699132149345"
        crossorigin="anonymous"></script>
        
        <style>
            /* 全体リセット・ベース設定 */
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            body {
                /* 例：Google Fonts 等で 'Merriweather' や 'Playfair Display' を読み込んだ上で */
                font-family: 'Merriweather', serif;
                margin: 0;
                background: linear-gradient(135deg, #fdfbfb, #ebedee);
            }

            /* ヘッダー */
            h1 {
                background: linear-gradient(90deg, #2c3e50, #4ca1af);
                color: #fff;
                padding: 20px;
                text-align: center;
                margin: 0;
                width: 100%;
                font-family: 'Playfair Display', serif;  /* 上質な印象のセリフ体 */
                text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            }

            /* メインコンテナー */
            .content-container {
                display: flex; 
                justify-content: space-between;
                gap: 20px;
                padding: 0px;
                /* 画面が狭いときは縦並びに */
                flex-wrap: wrap;
            }

            /* フォーム全体 */
            #horoscope-form {
                flex: 1;
                max-width: 100%;
                background-color: #fff;
                padding: 30px;
                border-radius: 12px;
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
                border: 1px solid #e0e0e0;
            }

            /* テーブルのスタイル */
            #horoscope-form table {
                width: 100%;
                border-collapse: collapse;
            }
            #horoscope-form th, 
            #horoscope-form td {
                padding: 16px 20px;
                border: none;
                border-bottom: 1px solid #e0e0e0;
                text-align: left;
                vertical-align: middle;
            }
            #horoscope-form th {
                background-color: transparent;
                color: #333;
                font-weight: bold;
            }
            #horoscope-form td {
                background-color: #fff;
            }

            /* input, select */
            input, select {
                width: 100%;
                padding: 8px;
                margin-top: 5px;
                box-sizing: border-box;
            }
            input,select {
            /* 高さを小さく設定 */
            height: 30px;
            line-height: 30px;
            
            /* 内側の余白 */
            padding: 0 10px;
            
            /* フォントサイズ */
            font-size: 16px;
            
            /* 枠線・角丸 */
            border: 1px solid #ccc;
            border-radius: 5px;
            
            /* 背景色 */
            background-color: #fff;
            
            /* iOS等でのデフォルトのスタイル（矢印など）を解除 */
            /* appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none; */
            
            /* レンダリングのためにボックスサイズを指定 */
            box-sizing: border-box;
            }
            #horoscope-form input[type="time"] {
                width: auto; 
                min-width: 100px;
            }

            /* 共通ボタンスタイルの変更 */
            button {
                margin-top: 20px;
                padding: 12px 24px;
                cursor: pointer;
                border-radius: 8px;
                font-size: 16px;
                border: none;
                transition: all 0.3s ease;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }
            button:hover:not(:disabled) {
                filter: brightness(95%);
                transform: translateY(-2px);
            }

            /* 各ボタンのカラー例 */
            /* 性格 */
            #submit-button1 {
                background: linear-gradient(45deg, #8e44ad, #9b59b6);
            }
            /* 恋愛運 */
            #submit-button2 {
                background: linear-gradient(45deg, #e74c3c, #e67e22);
            }
            /* 仕事運 */
            #submit-button3 {
                background: linear-gradient(45deg, #27ae60, #2ecc71);
            }
            /* 金運 (テキストは暗色) */
            #submit-button4 {
                background: linear-gradient(45deg, #f1c40f, #f39c12);
                color: #000;
            }
            /* 健康運 */
            #submit-button5 {
                background: linear-gradient(45deg, #16a085, #1abc9c);
            }
            /* 学業運 (テキストは暗色) */
            #submit-button6 {
                background: linear-gradient(45deg, #d35400, #e67e22);
                color: #000;
            }

            /* スピナーのスタイル */
            .spinner {
                border: 4px solid rgba(0, 0, 0, 0.1);
                border-top: 4px solid #4CAF50; 
                border-radius: 50%;
                width: 24px;
                height: 24px;
                animation: spin 1s linear infinite;
                display: inline-block;
                vertical-align: middle;
                margin-left: 10px;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            /* 結果表示のスタイル */
            #result,
            .result-sample {
                margin-top: 30px;
                padding: 15px;
                border: 1px solid #ccc;
                background-color: #f9f9f9;
                white-space: pre-line;
                font-size: 16px;
                color: #333;
            }
            /* resultDiv 内のリストのスタイルを調整 */
            #result ol,
            #result ul,
            .result-sample ol,
            .result-sample ul {
                margin-left: 1.5em;  /* 必要に応じて数値を調整 */
                padding-left: 0;
            }
            .horoscope-meaning ul {
                margin-left: 1.5em;  /* 必要に応じて数値を調整 */
                padding-left: 0;
            }

            /* エラーメッセージのスタイル */
            #error-message {
                color: red;
                margin-top: 10px;
            }

            /* 小さい説明文 */
            small {
                display: block;
                margin-top: 5px;
                color: #666;
            }

            /* テーブル配置用のラッパ */
            #container-table {
                margin: auto;
                width: 100%;
                max-width: 1000px;
            }

            /**
            * ホロスコープ描画用のコンテナ
            * ここを JavaScript 側で width/height を同じに設定します。
            */
            #chart-container {
                position: relative; /* 惑星ラベルを absolute 配置するため */
                margin: 0 auto;
                /* margin-bottom: 10px; */
                /* CSS 側では width/height を固定しない: JS で動的にセット */
                border: 1px solid #ccc;
                display: none; /* 最初は非表示 */
            }

            /* canvas はJSで (最大1000 x 1000) にします */
            #horoscope-canvas {
                display: block; /* ブロック要素化 */
                width: 100%;    /* ここで #chart-container と同じ幅にフィット */
                height: 100%;   /* 同上 */
                background: #99bbff;
            }

            
            /* モーダル関連 */
            .modal {
                display: none;
                position: fixed; 
                z-index: 1000; 
                left: 0;
                top: 0;
                width: 100%; 
                height: 100%; 
                overflow: auto; 
                background-color: rgba(0, 0, 0, 0.5); 
            }
            .modal-content {
                background-color: #fff;
                margin: 10% auto;
                padding: 5px;
                border: none;
                width: 80%;
                max-width: 700px;
                position: relative;
                border-radius: 12px;
                box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            }
            
            /* モーダル開閉ボタン */
            .open-modal-btn {
                background: linear-gradient(45deg, #2c3e50, #4ca1af); /* 高級感あるグラデーション */
                color: #fff;
                padding: 14px 28px;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: bold;
                text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                transition: transform 0.3s ease, filter 0.3s ease;
            }

            .open-modal-btn:hover {
                filter: brightness(95%);
                transform: translateY(-2px);
            }

            /* インプットやチェックボックスを横並びにする簡易レイアウト */
            .input-group {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .checkbox-label {
                display: flex;
                white-space: nowrap;
                gap: 4px;
            }

            /* ★ レスポンシブ（画面幅が768px以下の場合） */
            @media (max-width: 768px) {
                h1 {
                    font-size: 1.2em;
                    padding: 15px;
                }
                .content-container {
                    flex-direction: column;
                    align-items: center;
                }
                #container-table {
                    width: 100%;
                    max-width: 100%;
                }
                #horoscope-form th, 
                #horoscope-form td {
                    padding: 8px;
                    font-size: 0.9em;
                }
                .modal-content {
                    margin: 30% auto 0;
                    width: 90%;
                }
            }
            /* 全体コンテナ */
            .horoscope-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 10px;
            }

            /* ホロスコープ作成ボタン */
            .horoscope-create {
            text-align: center;
            }

            /* コンテナのスタイル */
            .analysis-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            /* 各ボタン共通のスタイル */
            .analysis-button button {
                padding: 10px 20px;
                font-size: 16px;
                border: none;
                border-radius: 5px;
                color: #fff;
                cursor: pointer;
                transition: background-color 0.3s ease, filter 0.3s ease;
            }
            .analysis-buttons {
            display: flex;
            justify-content: space-evenly; /* 均等にスペースを空ける */
            align-items: center; /* 垂直方向の中央揃え */
            }

            /* 各ボタンを同じ幅にしたい場合 */
            .analysis-button {
            flex: 1;                   /* 各要素の幅を均等に */
            display: flex;
            justify-content: center;   /* 内部のボタンを中央寄せ */
            }
            
            
            /* ホバー時：少し暗めに */
            .analysis-button button:hover:not(:disabled) {
                filter: brightness(90%);
            }
            
            /* disabled状態のスタイル */
            .analysis-button button:disabled {
                background-color: #ddd;
                color: #aaa;
                cursor: not-allowed;
            }
            

            /* 初期状態で非表示のスピナー */
            .spinner {
            display: none;
            }

            /* レスポンシブ対応：画面幅が600px以下の場合 */
            @media (max-width: 768px) {
            .analysis-buttons {
                flex-direction: column;
                align-items: center;
            }
            .analysis-button {
                width: 100%;
                margin-bottom: 10px;
            }
            }
            html, body {
            height: 100%;
            margin: 0;
            }
            /* ページ全体をラップするコンテナ */
            .wrapper {
            flex-direction: column;
            min-height: 100%;
            }
            /* コンテンツエリアは空いたスペースをすべて使う */
            .content {
            flex: 1;
            padding: 0px;
            }
            /* フッター（広告）のスタイル */
            .footer {
            background-color: #f9f9f9;
            text-align: center;
            padding: 10px 0;
            }
            /* 広告バナー全体のスタイル（中央寄せなど） */
            #ad-banner {
            text-align: center;
            margin: 20px auto;
            }
            /* デフォルトではデスクトップ広告を表示 */
            .desktop-ad {
            display: block;
            }
            .mobile-ad {
            display: none;
            }
            /* 画面幅が768px以下の場合はモバイル広告に切り替え */
            @media screen and (max-width: 768px) {
            .desktop-ad {
                display: none;
            }
            .mobile-ad {
                display: block;
            }
            }
            /* 3カラムレイアウト用のスタイル */
            .layout-wrapper {
            display: flex;
            justify-content: center; /* 中央寄せ */
            align-items: flex-start;
            gap: 20px; /* 広告と中央コンテンツの間の隙間 */
            max-width: 1600px; /* コンテンツ全体の最大幅 */
            margin: 0 auto;
            padding: 0px;
            }

            /* 広告エリアのスタイル */
            .side-ad {
            flex: 0 0 250px; /* 固定幅 160px（必要に応じて調整） */
            }

            /* 中央コンテンツエリア */
            .main-content {
            flex: 1;
            background-color: transparent;
            padding: 0px;
            /* border-radius: 12px; */
            /* box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); */
            /* border: 1px solid #e0e0e0; */
            }

            /* レスポンシブ対応：画面幅が768px以下の場合は広告を非表示に */
            @media (max-width: 768px) {
            .layout-wrapper {
                flex-direction: column;
                padding: 10px;
            }
            .side-ad {
                display:flexbox;
            }
            .main-content {
                width: 100%;
            }
            }
            /* サイドバー全体のスタイル */
            .side-ad {
            background-color: #f7f7f7;      /* やわらかい背景色 */
            border: 1px solid #ddd;         /* 薄い枠線 */
            padding: 15px;
            border-radius: 8px;             /* 角を丸く */
            margin: 10px;
            font-family: 'Arial', sans-serif;
            }

            /* 左寄せのサイドバー用（必要に応じて調整） */
            .left-ad {
            float: left;
            width: 250px;                   /* 幅は調整可能 */
            }

            /* リスト全体のリセット */
            .ad-content ul {
            list-style: none;               /* デフォルトのマーカーを非表示 */
            margin: 0;
            padding: 0;
            }

            /* 各リストアイテムの間隔 */
            .ad-content ul li {
            margin-bottom: 10px;
            }

            /* リンクのスタイル */
            .ad-content ul li a {
            display: block;                 /* リンク全体をブロック要素に */
            text-decoration: none;          /* 下線なし */
            color: #333;
            font-weight: bold;
            padding: 8px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: background-color 0.3s, color 0.3s;
            }

            /* リンクホバー時のスタイル */
            .ad-content ul li a:hover {
            background-color: #e9e9e9;
            color: #000;
            }

            img {
            max-width: 100%;
            height: auto;
            }
        </style>
    </head>
    
    <body>
        <div class="wrapper">
            <h1>無料ホロスコープ作成・占い - AI占星術師アオポン</h1>
            <div class="layout-wrapper">
                <aside class="side-ad left-ad">
                    <div class="ad-content">
                        <ul>
                            <li><a href="#howtouse">利用方法</a></li>
                            <li><a href="#horoscope-sample">ホロスコープのサンプル（大谷翔平さん）</a></li>
                            <li><a href="#analysis-sample1">AIによる分析結果のサンプル（大谷翔平さん）性格</a></li>
                            <li><a href="#analysis-sample2">AIによる分析結果のサンプル（大谷翔平さん）仕事運</a></li>
                            <li><a href="#horoscope-meaning">コラム ホロスコープの意味するところ</a></li>
                        </ul>
                        <a href="https://px.a8.net/svt/ejp?a8mat=44YP7H+D15N0I+2PEO+1BWBM9" rel="nofollow">
                            <img border="0" width="300" height="250" alt="" src="https://www26.a8.net/svt/bgt?aid=250202141788&wid=003&eno=01&mid=s00000012624008045000&mc=1"></a>
                            <img border="0" width="1" height="1" src="https://www12.a8.net/0.gif?a8mat=44YP7H+D15N0I+2PEO+1BWBM9" alt="">
                    </div>
                </aside>
                <!-- 中央メインコンテンツエリア -->
                <main class="main-content">
                    <!-- コンテンツエリア -->
                    <div class="content">
                        <div class="content-container">
                            
                            <div id="data" style="width: 100%;">
                                <form id="horoscope-form" method="POST" action="#">
                                    {% csrf_token %}
                                    <table>
                                        <tbody>
                                            <tr>
                                                <th>生年月日</th>
                                                <td>
                                                    <select name="year" id="year-select">
                                                        {% for year in years %}
                                                            <option value="{{ year }}">{{ year }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    <select name="month" id="month-select">
                                                        {% for month in months %}
                                                            <option value="{{ month }}">{{ month }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    <select name="day" id="day-select">
                                                        {% for day in days %}
                                                            <option value="{{ day }}">{{ day }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>出生時刻</th>
                                                <td>
                                                    <div class="input-group">
                                                        <input type="time" id="time" name="time" required />
                                                        <label for="unknown" class="checkbox-label">
                                                            <input type="checkbox" id="unknown" name="unknown" />
                                                            <span style="display: inline;">不明</span>
                                                        </label>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>出生地</th>
                                                <td>
                                                    <select name="prefecture" id="prefecture">
                                                        <option value="Hokkaido" data-lat="43.06417" data-lon="141.34694">北海道</option>
                                                        <option value="Aomori" data-lat="40.82444" data-lon="140.74">青森県</option>
                                                        <option value="Iwate" data-lat="39.70361" data-lon="141.1525">岩手県</option>
                                                        <option value="Miyagi" data-lat="38.26889" data-lon="140.87194">宮城県</option>
                                                        <option value="Akita" data-lat="39.71861" data-lon="140.1025">秋田県</option>
                                                        <option value="Yamagata" data-lat="38.24056" data-lon="140.36333">山形県</option>
                                                        <option value="Fukushima" data-lat="37.75" data-lon="140.46778">福島県</option>
                                                        <option value="Ibaraki" data-lat="36.34139" data-lon="140.44667">茨城県</option>
                                                        <option value="Tochigi" data-lat="36.56583" data-lon="139.88361">栃木県</option>
                                                        <option value="Gunma" data-lat="36.39111" data-lon="139.06083">群馬県</option>
                                                        <option value="Saitama" data-lat="35.85694" data-lon="139.64889">埼玉県</option>
                                                        <option value="Tokyo" data-lat="35.6895" data-lon="139.6917" selected>東京都</option>
                                                        <option value="Chiba" data-lat="35.60506" data-lon="140.12333">千葉県</option>
                                                        <option value="Kanagawa" data-lat="35.44778" data-lon="139.6425">神奈川県</option>
                                                        <option value="Niigata" data-lat="37.90222" data-lon="139.02361">新潟県</option>
                                                        <option value="Toyama" data-lat="36.69529" data-lon="137.21134">富山県</option>
                                                        <option value="Ishikawa" data-lat="36.59444" data-lon="136.62556">石川県</option>
                                                        <option value="Fukui" data-lat="36.06528" data-lon="136.22194">福井県</option>
                                                        <option value="Yamanashi" data-lat="35.66389" data-lon="138.56833">山梨県</option>
                                                        <option value="Nagano" data-lat="36.65139" data-lon="138.18111">長野県</option>
                                                        <option value="Gifu" data-lat="35.39111" data-lon="136.72222">岐阜県</option>
                                                        <option value="Shizuoka" data-lat="34.97694" data-lon="138.38306">静岡県</option>
                                                        <option value="Aichi" data-lat="35.18028" data-lon="136.90667">愛知県</option>
                                                        <option value="Mie" data-lat="34.73028" data-lon="136.50859">三重県</option>
                                                        <option value="Shiga" data-lat="35.00444" data-lon="135.86833">滋賀県</option>
                                                        <option value="Kyoto" data-lat="35.02139" data-lon="135.75556">京都府</option>
                                                        <option value="Osaka" data-lat="34.68639" data-lon="135.52">大阪府</option>
                                                        <option value="Hyogo" data-lat="34.69139" data-lon="135.18306">兵庫県</option>
                                                        <option value="Nara" data-lat="34.68528" data-lon="135.83278">奈良県</option>
                                                        <option value="Wakayama" data-lat="34.22611" data-lon="135.1675">和歌山県</option>
                                                        <option value="Tottori" data-lat="35.50361" data-lon="134.23833">鳥取県</option>
                                                        <option value="Shimane" data-lat="35.47222" data-lon="133.05056">島根県</option>
                                                        <option value="Okayama" data-lat="34.66167" data-lon="133.935">岡山県</option>
                                                        <option value="Hiroshima" data-lat="34.39639" data-lon="132.45962">広島県</option>
                                                        <option value="Yamaguchi" data-lat="34.18583" data-lon="131.47139">山口県</option>
                                                        <option value="Tokushima" data-lat="34.06583" data-lon="134.55944">徳島県</option>
                                                        <option value="Kagawa" data-lat="34.34028" data-lon="134.04333">香川県</option>
                                                        <option value="Ehime" data-lat="33.84167" data-lon="132.76556">愛媛県</option>
                                                        <option value="Kochi" data-lat="33.55972" data-lon="133.53108">高知県</option>
                                                        <option value="Fukuoka" data-lat="33.60639" data-lon="130.41806">福岡県</option>
                                                        <option value="Saga" data-lat="33.24944" data-lon="130.29889">佐賀県</option>
                                                        <option value="Nagasaki" data-lat="32.74472" data-lon="129.87361">長崎県</option>
                                                        <option value="Kumamoto" data-lat="32.78972" data-lon="130.74167">熊本県</option>
                                                        <option value="Oita" data-lat="33.23806" data-lon="131.6125">大分県</option>
                                                        <option value="Miyazaki" data-lat="31.91111" data-lon="131.42389">宮崎県</option>
                                                        <option value="Kagoshima" data-lat="31.56028" data-lon="130.55806">鹿児島県</option>
                                                        <option value="Okinawa" data-lat="26.2125" data-lon="127.68111">沖縄県</option>
                                                    </select>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    
                                    <!-- 緯度/経度 (自動セット) -->
                                    <input type="hidden" step="0.0001" name="lat" id="lat" required readonly>
                                    <input type="hidden" step="0.0001" name="lon" id="lon" required readonly>
                                    <input type="hidden" step="0.1" name="tz" required value="9.0">
                                    <input type="hidden" step="0.1" name="dst" required value="0.0">
                            
                                    <div id="error-message"></div>
                                    
                                    <div class="horoscope-container">
                                        <!-- ホロスコープ作成ボタン -->
                                        <div class="horoscope-create">
                                        <button type="button" id="draw-button" class="open-modal-btn">ホロスコープを作成</button>
                                        <button type="button" id="view-button" class="open-modal-btn">ホロスコープの詳細</button>
                                        </div>
                                        <div style="text-align: right;">
                                            <span style="font-size: x-small;">（プラシーダス方式で描きます。）</span>
                                        </div>
                                        <hr>
                                        <div style="text-align: center;">
                                            <span>以下から占いたい項目を選んでください。<br>AI占星術師アオポンがあなたのホロスコープから占います。</span>
                                        </div>
                                        <hr>
                                        <!-- 占いボタン群 -->
                                        <div class="analysis-buttons">
                                        <div class="analysis-button">
                                            <button type="submit" id="submit-button1">性格</button>
                                            <div id="spinner1" class="spinner"></div>
                                        </div>
                                        <div class="analysis-button">
                                            <button type="submit" id="submit-button2">恋愛運</button>
                                            <div id="spinner2" class="spinner"></div>
                                        </div>
                                        <div class="analysis-button">
                                            <button type="submit" id="submit-button3">仕事運</button>
                                            <div id="spinner3" class="spinner"></div>
                                        </div>
                                        <div class="analysis-button">
                                            <button type="submit" id="submit-button4">金運</button>
                                            <div id="spinner4" class="spinner"></div>
                                        </div>
                                        <div class="analysis-button">
                                            <button type="submit" id="submit-button5">健康運</button>
                                            <div id="spinner5" class="spinner"></div>
                                        </div>
                                        <div class="analysis-button">
                                            <button type="submit" id="submit-button6">学業運</button>
                                            <div id="spinner6" class="spinner"></div>
                                        </div>
                                        </div>
                                    </div>
                                    <small>※AIがその都度鑑定を行うため、30秒~3分ほどかかります。</small>
                                    
                                    <!-- 占い結果表示 -->
                                    <div id="result">回答がここに表示されます</div>
                                    
                                    <hr>
                                    <div id="ad-banner">
                                        <div id="ad-banner">
                                            <div class="desktop-ad">
                                                <a href="https://px.a8.net/svt/ejp?a8mat=44YP7H+8KELOI+2PEO+C4LLD" rel="nofollow">
                                                <img border="0" width="300" height="250" alt="" src="https://www29.a8.net/svt/bgt?aid=250202141518&wid=003&eno=01&mid=s00000012624002037000&mc=1"></a>
                                                <img border="0" width="1" height="1" src="https://www12.a8.net/0.gif?a8mat=44YP7H+8KELOI+2PEO+C4LLD" alt="">
                                                <a href="https://px.a8.net/svt/ejp?a8mat=44YP7H+D15N0I+2PEO+1BRTKX" rel="nofollow">
                                                <img border="0" width="300" height="250" alt="" src="https://www21.a8.net/svt/bgt?aid=250202141788&wid=003&eno=01&mid=s00000012624008024000&mc=1"></a>
                                                <img border="0" width="1" height="1" src="https://www16.a8.net/0.gif?a8mat=44YP7H+D15N0I+2PEO+1BRTKX" alt="">
                                            </div>
                                            <div class="mobile-ad">
                                                <a href="https://px.a8.net/svt/ejp?a8mat=44YP7H+8KELOI+2PEO+C4LLD" rel="nofollow">
                                                <img border="0" width="300" height="250" alt="" src="https://www29.a8.net/svt/bgt?aid=250202141518&wid=003&eno=01&mid=s00000012624002037000&mc=1"></a>
                                                <img border="0" width="1" height="1" src="https://www12.a8.net/0.gif?a8mat=44YP7H+8KELOI+2PEO+C4LLD" alt="">
                                                <a href="https://px.a8.net/svt/ejp?a8mat=44YP7H+D15N0I+2PEO+1BRTKX" rel="nofollow">
                                                <img border="0" width="300" height="250" alt="" src="https://www21.a8.net/svt/bgt?aid=250202141788&wid=003&eno=01&mid=s00000012624008024000&mc=1"></a>
                                                <img border="0" width="1" height="1" src="https://www16.a8.net/0.gif?a8mat=44YP7H+D15N0I+2PEO+1BRTKX" alt="">
                                            </div>
                                        </div>
                                    </div>
                                    <br>
                                    <br>
                                    <hr>
                                    <a id="howtouse"></a>
                                    <div>
                                        <h3>このサイトの利用方法</h3>
                                        <div>
                                            <p>1.占いたい人の生年月日、出生時刻、出生地を入力します。（出生時刻が分からない場合は不明にチェックを入れてください。）</p>
                                            <p>2.ホロスコープを作成ボタンからホロスコープを作成できます。（モーダルウィンドウとして表示されます。）</p>
                                            <p>3.ホロスコープの詳細を見たい場合は、ホロスコープの詳細ボタンを押してください。</p>
                                            <p>4.その後、占いたい項目をカラフルな6つのボタンから選択してください。</p>
                                            <p>5.ボタンを押すとAIが<strong>惑星の配置だけに基づいて</strong>、解析結果を占ってくれます。</p>
                                            <p>この解析結果の作成にはOpenAIのAPIを利用しています。</p>
                                            <p>読み込み時のページの幅に応じてホロスコープの作成を押したときに表示されるホロスコープの大きさが変わります。</p>
                                        </div>
                                    </div>

                                    <br>
                                    <br>
                                    <a id="horoscope-sample"></a>
                                    <hr>
                                    <div>
                                        <h3>ホロスコープのサンプル（大谷翔平さん）</h3>
                                        <div>
                                            <p>以下に例として1994/7/5 21:05 岩手県生まれの大谷翔平さんのホロスコープのサンプルを表示します。</p>
                                            <p>このように見やすいホロスコープが作れます。</p>
                                        </div>
                                        <div style="text-align: center;">
                                            <img src="{% static 'path/to/horoscope-otani.png' %}" alt="horoscope demo image">
                                        </div>
                                    </div>
                                    <br>
                                    <br>
                                    <a id="analysis-sample1"></a>
                                    <hr>
                                    <div>
                                        <h3>AIによる分析結果のサンプル（大谷翔平さん）性格</h3>
                                        <div>
                                            <p>同様に例として大谷翔平さんの性格を占った結果を載せます。</p>
                                            <p>このように分かりやすい解析結果が得られます。</p>
                                            <p>「革新性やユニークさ、友愛精神がにじみ出ており、時には既存の枠にとらわれず新しい価値観を提示することも」という点なんかはそのまま二刀流をイメージさせてくれます。</p>
                                        </div>
                                    </div>
                                    <div id="result-sample1" class="result-sample"><p>以下は、このネイタルチャートから読み取れる性格の傾向です。各天体のサインやハウス、アスペクトの意味を踏まえ、総合的に以下のような特徴が見受けられます。</p>
                                        <p>【1. 内面の感受性と家庭的・保護的なエネルギー】<br>・太陽が蟹座の5ハウスにあることから、この方は本質的に温かく、家庭や家族、子どもたちとの関わりを大切にする傾向があります。保護本能が強く、人を思いやる優しさや感受性、情緒的な豊かさがみられます。<br>・ただし、月が双子座に位置しているため、感情の変化が早く、知的な刺激やコミュニケーションを通じて安心感を得る傾向もあります。  </p>
                                        <p>【2. 知的好奇心とコミュニケーションの多彩さ】<br>・月、火星、水星がすべて双子座にあるため、知的好奇心が旺盛で、常に新しい情報や学びを求め、コミュニケーションや情報交換を積極的に行う面があります。<br>・水星は双子座の末度にあり、また5ハウスに位置するため、創造的な発想や表現力が豊かで、芸術的・エンターテインメント的な才能もあるでしょう。<br>・ただし、双子座の性質上、時に情報が多すぎたり、集中力に散漫な面が出やすいため、何事も多角的に捉える反面、深く掘り下げるのに苦労することもあるかもしれません。</p>
                                        <p>【3. 社交性と個性的な魅力】<br>・アセンダントが水瓶座ということから、外見や第一印象は個性的で、独自性や自由さを大切にする印象を与えます。革新性やユニークさ、友愛精神がにじみ出ており、時には既存の枠にとらわれず新しい価値観を提示することも。<br>・ミッドヘヴェンが射手座にあることは、キャリアや公の場面で冒険心や探求心を発揮できることを示唆し、理想やビジョンに基づいて行動する傾向が見られます。</p>
                                        <p>【4. 恋愛・対人関係における情熱とドラマ】<br>・金星は獅子座にあり、7ハウス（パートナーシップ）に位置するため、恋愛面では情熱的で自己表現が豊か、相手に対して暖かく献身的な愛情を示します。<br>・しかし、金星と火星、さらに金星と冥王星とのスクエア（緊張的なアスペクト）があることから、恋愛や対人関係において、情熱のあまり自己主張や衝突が生じやすい面も。<br>・感情表現にドラマが伴うため、相手との力関係や支配の問題に敏感になりがちな可能性があります。</p>
                                        <p>【5. 成長と自己実現のための内面の調整】<br>・太陽と土星のトラインは、自己規律や責任感、努力を通じて着実に成長を遂げる力を示しています。自分の内面と向き合い、現実感を持って物事に取り組む姿勢があるでしょう。<br>・一方、月と土星のスクエアは、感情や家庭的な安心感を求める一方で、内面的な制限や不安、自己批判が働く可能性も示唆します。そのため、感情のバランスを取るための自己理解や自己肯定が求められる場面があるかもしれません。</p>
                                        <p>【6. 内面的な挑戦と変革への駆動力】<br>・木星や冥王星が蠍座に位置し、また北ノードも蠍座にあることから、深い内面的探求や変容、再生のテーマが人生において大きな意味を持ちます。人生の中で感情の極みやタブーに向き合い、自らを変革する強い意志が感じられます。<br>・火星と冥王星のオポジションは、内面の衝動や欲求、パワーバランスの問題に直面することを示し、時には激しい内面闘争を伴うことも。しかし、そのエネルギーをうまく活かすことで、自己の深い成長や大きな変化をもたらす可能性があります。</p>
                                        <p>【7. 社会性と実務面での現実感】<br>・天王星と海王星が山羊座に位置し、またハウスでも12ハウスに位置していることから、現実世界においては、独創性と実務的な感覚とが融合している傾向が見受けられます。新しい制度や形態、組織の中で革新をもたらす能力が備わっています。<br>・また、土星が魚座であることは、感受性豊かでありながらも、現実との折り合いをどうつけるかという課題を持っており、人や世界に対する共感と境界線の設定が鍵となります。</p>
                                        <p>【まとめ】<br>この方は、基本的に温かい心と家庭的な優しさ（蟹座の太陽）を持ちながら、知的な多様性やコミュニケーション能力（双子座の月・水星・火星）によって、周囲と柔軟に情報をやり取りする才能を発揮します。加えて、個性的で革新的な外見（アセンダント水瓶座）と、恋愛や人間関係においてドラマティックな情熱（金星獅子座）が特徴です。内面では、責任感や自己規律（太陽トライン土星）を大切にしつつも、時には感情の抑制や内面的な衝突（スクエア・オポジションのアスペクト）に苦しむ面もあります。総じて、感受性と知性、そして情熱が絶妙に交錯する、非常に多面的で魅力的な性格を持つと考えられます。</p>
                                        <p>このように、多様なエネルギーが絡み合うため、環境や状況に応じた柔軟な対応ができる一方、自己の内面との調和を図ることが今後の鍵となるでしょう。</p>
                                    </div>
                                    
                                    <br>
                                    <br>
                                    <a id="analysis-sample2"></a>
                                    <hr>
                                    <div>
                                        <h3>AIによる分析結果のサンプル（大谷翔平さん）仕事運</h3>
                                        <div>
                                            <p>続けて例として大谷翔平さんの仕事運を占った結果を載せます。</p>
                                            <p>このように分かりやすい解析結果が得られます。</p>
                                            <p>「海外」で成功するとか、「常に新しいアイデアや冒険的なアプローチを求める傾向があり、独自の道を切り開く力を持っています」という点なんかはイメージの通りだなと思いました。</p>
                                        </div>
                                    </div>

                                    <div id="result-sample2" class="result-sample">
                                        <p>以下のチャートから読み取れる、仕事運・キャリアに関する主な傾向は下記のとおりです。</p>
                                        <p>■【ミッドヘヴェン（天頂）の影響】<br>・ミッドヘヴェンは射手座（7°28'）に位置しているため、理想主義的で広い視野を持ち、海外や学問、哲学、教育、法律、出版など、知識や経験を通して成長できる分野に適性があると考えられます。<br>・また、常に新しいアイデアや冒険的なアプローチを求める傾向があり、独自の道を切り開く力を持っています。</p>
                                        <p>■【ハウス配置とルーラーの関係】<br>・10ハウスのカスプは射手座ですが、その支配星である木星が8ハウス（蠍座 4°47'）に位置しており、他者との金銭的な関わりやパートナーシップ、あるいは共同資源、さらには危機や変革を伴うテーマがキャリアに影響する可能性があります。<br>　→　たとえば、共同経営、金融、調査、心理学、またはリサーチなど、他人のリソースや信頼を活かす仕事に強みが出るでしょう。</p>
                                        <p>■【メインプラネットの居場所からの示唆】<br>・太陽（蟹座 13°15'）が5ハウスにあるため、創造性や表現力、感情面を活かす仕事（クリエイティブな分野、サービス業、子どもや家族関係に関わる分野など）にやりがいを感じやすいです。<br>・水星（双子座 29°29'）も5ハウスにあるため、コミュニケーション能力や情報発信、出版、マーケティング、セールスなど、言葉を用いた活動での才能が光ります。<br>・月（双子座 4°26'）や火星（双子座 1°07'）が3ハウスにあることから、日々の情報収集や交渉、迅速な対応力も持ち、ネットワーキングや営業、流通関連の仕事にも向いています。</p>
                                        <p>■【アスペクトからの調整と強み】<br>・【太陽トライン土星】のアスペクトは、自己表現と自己管理、責任感・忍耐力の面で大きなサポートとなる配置です。自身の感性（太陽）と現実的な努力（長期的な計画を示す土星）が調和しており、困難な状況でも着実に前進できる力となります。<br>・【水星トライン木星】は、コミュニケーションや学び、ビジネスにおいて豊かな発想と説得力をもたらし、言葉や情報を生かした仕事で大きな成果が期待できます。<br>・【火星トライン天王星】は、独創性と行動力を示すため、斬新なアイデアを実行に移す力、革新的なプロジェクトへの取り組みが得意といえます。</p>
                                        <p>■【注意すべきチャレンジ】<br>・月と土星のスクエアは、感情面でのストレスや上司・同僚との関係、あるいは自己表現と責任感との間に摩擦が起こりやすい配置です。特に、感情のコントロールや自己評価のバランスに注意する必要があるかもしれません。<br>・また、金星と火星、金星と冥王星とのスクエアは、職場内での対人関係やパワーバランス、意見の衝突を引き起こす可能性があるため、人間関係を円滑に保つための工夫が必要です。</p>
                                        <p>■【全体的な仕事運のまとめ】<br>・総じて、あなたの仕事運は「拡大・冒険」「創造性」「コミュニケーション力」を中心に展開すると読み取れます。<br>・理想やビジョンを掲げ、柔軟な発想と情報処理能力を活かすキャリアを志向すると良いでしょう。海外展開、教育・研究、出版、マーケティング、またはパートナーシップを活用した事業など、多岐にわたる分野での活躍が期待されます。<br>・一方で、時には感情と責任感のバランス、職場内の人間関係における摩擦に注意する必要があるため、自己管理やストレスコーピングが鍵となります。</p>
                                        <p>以上の観点から、あなたは自らの独自性と才能を活かして、変化と成長を求める分野で成功を収める運勢があり、慎重な自己管理と周囲との調和を心がけることで、キャリアにおける飛躍が期待できると考えられます。</p>
                                    </div>
                                    <br>
                                    <br>
                                    <a id="horoscope-meaning"></a>
                                    <hr>
                                    <div>
                                        <div class="horoscope-meaning">
                                            <h3>コラム</h3>
                                            <h3>ホロスコープの意味するところ：天体が映し出すあなた自身の物語</h3>

                                            <p>占星術は、太古の昔から星々の運行を通じて人間の営みを読み解こうとしてきました。</p>
                                            <p>現代においても、ホロスコープは単なる未来予測の道具ではなく、自己理解と人生の指針を与えてくれる大切なコンパスとなっています。</p>
                                            <p>ここでは、ホロスコープが意味するところについて、その深い背景と実践的な意義を探ってみたいと思います。</p>
                                            <br>

                                            <h4>1. 天体の配置が示す「宇宙との対話」</h4>
                                            <p>ホロスコープは、誕生の瞬間における天体の位置を基に作成されます。太陽、月、惑星、アセンダントといった天体の配置は、個々の性格、才能、潜在的な課題や人生のテーマを象徴するとされています。これらは、宇宙があなたに与えた「プログラム」のようなものであり、どの天体がどの星座に位置しているか、またその天体同士がどのようなアスペクト（角度）を形成しているかは、あなたの内面世界や外部との関係性を映し出す鏡です。</p>
                                            <br>
                                            <h4>2. ホロスコープは未来を予言するのではなく、内面への気づきを促す</h4>
                                            <p>よく誤解される点として、ホロスコープは「運命を決定する未来予知ツール」というイメージがあります。しかし、占星術の真髄は、あくまで自己理解と成長のためのガイドラインにあります。天体の動きは、あくまであなたが持つ可能性や傾向を示すものであり、未来は常に変化しうるものです。ホロスコープは、どんな困難な時も「内面に目を向け、自己改革を促すチャンス」として活用することで、より充実した人生を歩むためのヒントとなります。</p>
                                            <br>
                                            <h4>3. 各天体と星座が語るあなたの物語</h4>
                                            <ul>
                                                <li>太陽は、あなたの中心的なエネルギーと本質を示し、ライフパーパス（生きる意味）に深く関わります。</li>
                                                <li>月は、内面の感情や無意識、心の反応を映し出し、情緒的な側面を理解する鍵となります。</li>
                                                <li>水星は、思考やコミュニケーションのスタイルを表し、知性や情報処理の在り方に光を当てます。</li>
                                                <li>金星は、愛情、価値観、美意識といった、心の豊かさに関連するテーマを象徴します。</li>
                                                <li>火星は、行動力や情熱、エネルギーの発散を示し、あなたがどのように目標に向かって突き進むかを描き出します。</li>
                                            </ul>
                                        
                                            <p>各惑星が属する星座は、その天体の性質に色を添え、どのような方法でそれらのエネルギーが表現されるかを示します。また、ハウス（宮）の位置は、天体が人生のどの分野に影響を及ぼすかを具体的に明らかにします。</p>
                                            <br>

                                            <h4>4. 自己理解への道しるべとしてのホロスコープ</h4>
                                            <p>ホロスコープは、自己探求の旅において大変貴重なツールです。例えば、苦難や試練の時期が訪れると、ホロスコープはその背景にある潜在的なパターンを読み解く助けとなります。そして、どのような課題に取り組むべきか、どの分野で成長が期待できるかといった、人生の「羅針盤」として活用することができるのです。</p>
                                            
                                            <p>また、ホロスコープは他者との関係性（シナストリー）を読み解くためにも利用されます。人間関係における相性や、互いのエネルギーがどのように交錯しているのかを知ることで、対人関係の改善や円滑なコミュニケーションに繋がります。</p>
                                            <br>
                                            <h4>5. 結びに</h4>
                                            <p>ホロスコープは、星々の神秘的な運行を通じてあなた自身の内面や人生のテーマを浮かび上がらせる、奥深い自己理解のツールです。決して未来を固定的に示すものではなく、あなたがどのように生き、どのように成長するかの可能性を示唆するガイドラインです。星々が紡ぐ物語に耳を傾け、その声に導かれながら、自分自身の本当の姿を見つけ出す旅に出てみてはいかがでしょうか。</p>
                                            
                                            <p>このコラムが、あなた自身のホロスコープに秘められた意味を探る一助となり、内なる光を見出すヒントとなることを願っています。</p>
                                        </div>
                                    </div>

                                </form>


                            </div>
                            
                            <!-- モーダル -->
                            <div id="chart-modal" class="modal">
                                <div class="modal-content">
                                    <div id="chart-container">
                                        <!-- ホロスコープ描画領域 (JSで width/height を可変に) -->
                                        <canvas id="horoscope-canvas"></canvas>
                                        <!-- 保存ボタン -->
                                        <button onclick="saveCanvasAsImage()">保存</button>
                                        <button id="close-button">閉じる</button>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </main>
            </div> <!-- .layout-wrapper -->
            
        </div>


        <!-- (A) 時刻不明チェックボックスの自動処理 -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const timeInput = document.getElementById('time');
                const unknownCheckbox = document.getElementById('unknown');
            
                unknownCheckbox.addEventListener('change', function () {
                    if (this.checked) {
                        timeInput.value = '';
                    } else {
                        // timeInput.value = '';
                    }
                });
            });
        </script>

        <!-- (B) モーダル開閉スクリプト -->
        <script>
            const modal = document.getElementById("chart-modal");
            const btn = document.getElementById("draw-button");
            const closebtn = document.getElementById("close-button");

            btn.onclick = function() {
                modal.style.display = "block";
            };
            closebtn.onclick = function() {
                modal.style.display = "none";
            };
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            };
        </script>

        <!-- (C) クッキー周りのヘルパー関数 (必要な場合) -->
        <script>
            function setCookie(name, value, days) {
                const d = new Date();
                d.setTime(d.getTime() + (days*24*60*60*1000));
                const expires = "expires="+ d.toUTCString();
                document.cookie = `${name}=${value};${expires};path=/`;
            }
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        </script>

        <!-- (D) フォームの入力値をクッキーに保存＆復元 (必要に応じて) -->
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const yearSelect = document.getElementById('year-select');
                const monthSelect = document.getElementById('month-select');
                const daySelect = document.getElementById('day-select');
                const timeInput = document.querySelector('input[name="time"]');
                const prefectureSelect = document.getElementById('prefecture');
                const checkboxSelect = document.getElementById('unknown');

                // クッキーから読み込む例 (省略可)
                const savedYear = getCookie('horoscope_year');
                const savedMonth = getCookie('horoscope_month');
                const savedDay = getCookie('horoscope_day');
                const savedTime = getCookie('horoscope_time');
                const savedPrefecture = getCookie('horoscope_prefecture');
                const savedCheckbox = getCookie('horoscope_checkbox');

                if (yearSelect && savedYear) {
                    yearSelect.value = savedYear;
                }
                if (monthSelect && savedMonth) {
                    monthSelect.value = savedMonth;
                }
                if (daySelect && savedDay) {
                    daySelect.value = savedDay;
                }
                if (timeInput && savedTime !== null) {
                    timeInput.value = savedTime;
                }
                if (checkboxSelect && savedCheckbox !== null) {
                    checkboxSelect.checked = (savedCheckbox === 'true');
                }
                if (prefectureSelect && savedPrefecture) {
                    const options = prefectureSelect.options;
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].value === savedPrefecture) {
                            prefectureSelect.selectedIndex = i;
                            break;
                        }
                    }
                }

                // デフォルト値の設定（Cookieに該当値がない場合のみ）
                if (!savedYear || !savedMonth || !savedDay) {
                    const now = new Date();
                    if (yearSelect && !savedYear)  yearSelect.value  = now.getFullYear();
                    if (monthSelect && !savedMonth) monthSelect.value = String(now.getMonth() + 1);
                    if (daySelect && !savedDay)     daySelect.value   = String(now.getDate());
                }
                if (!savedTime && savedCheckbox == null) {
                    const now = new Date();
                    const hours   = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    if (timeInput) timeInput.value = `${hours}:${minutes}`;
                }
                // 都道府県切り替え
                if (prefectureSelect) {
                    function updateLatLon(e) {
                        const selected = e.target.selectedOptions[0];
                        document.getElementById('lat').value = selected.getAttribute('data-lat');
                        document.getElementById('lon').value = selected.getAttribute('data-lon');
                    }
                    // 初期化
                    const defaultSelected = prefectureSelect.selectedOptions[0];
                    document.getElementById('lat').value = defaultSelected.getAttribute('data-lat');
                    document.getElementById('lon').value = defaultSelected.getAttribute('data-lon');
                    // 変更イベント
                    prefectureSelect.addEventListener('change', updateLatLon);
                }
            });
        </script>
        
        <!-- (E) フォーム送信（ボタンクリック）本番運用 -->
        <script>
            
            // Django等でCSRFトークンがセットされている想定
            const csrftoken = getCookie('csrftoken');
            
            // 送信ボタンの要素（例: 3つのボタン）
            const submitButtons = [
            document.getElementById('submit-button1'),
            document.getElementById('submit-button2'),
            document.getElementById('submit-button3'),
            document.getElementById('submit-button4'),
            document.getElementById('submit-button5'),
            document.getElementById('submit-button6')
            ];
            const resultDiv = document.getElementById('result');

            // フォームデータをオブジェクトに変換するヘルパー関数
            const formDataToObject = formData => {
                const data = {};
                formData.forEach((value, key) => data[key] = value);
                return data;
            };
            
            // クッキーに保存する関数
            function saveFormDataToCookies(formData) {
                const data = formDataToObject(formData);
                setCookie('horoscope_year', data.year, 30); // 30日間有効
                setCookie('horoscope_month', data.month, 30); // 30日間有効
                setCookie('horoscope_day', data.day, 30); // 30日間有効
                setCookie('horoscope_time', data.time, 30);
                setCookie('horoscope_prefecture', data.prefecture, 30);
                
                // チェックボックスの状態を 'true' または 'false' で保存
                const isChecked = formData.has('unknown') ? 'true' : 'false';
                setCookie('horoscope_checkbox', isChecked, 30);
            }
            
            // 送信ハンドラー生成関数
            const createSubmitHandler = (sbValue, spinnerId) => async e => {
                e.preventDefault();
                
                const form = e.target.form;
                if (!form) return;

                try {
                    // フォームデータ処理
                    const formData = new FormData(form);
                    const data = formDataToObject(formData);
                    
                    // 日付と時刻の分解
                    // const [year, month, day] = data.date.split('-');
                    const year = data.year;
                    const month = data.month;
                    const day = data.day;
                    const time  = data.time || "12:00";
                    const [hour, minute] = time.split(':');
                    const unknown = data.unknown;
                    console.log("送信する値:", unknown); // デバッグ用

                    // 送信データの組み立て
                    const sendData = {
                        year: year,
                        month: month,
                        day: day,
                        hour: hour,
                        minute: minute,
                        lat: data.lat,
                        lon: data.lon,
                        tz: data.tz,
                        dst: data.dst,
                        sb: sbValue,
                        unknown: unknown
                    };

                    // UI状態更新
                    submitButtons.forEach(btn => btn.disabled = true);
                    const spinner = document.getElementById(spinnerId);
                    if (spinner) spinner.style.display = 'inline-block';

                    // APIリクエスト
                    const response = await fetch("{% url 'horoscope_app:analyze' %}", {
                    method: 'POST',
                    credentials: 'same-origin',  // これを追加
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrftoken
                    },
                    body: new URLSearchParams(sendData)
                    });

                    // レスポンス処理
                    const content = await response.json();
                    if (!response.ok) throw new Error(content.error || 'Unknown error');

                    // Markdown処理とサニタイズ
                    const cleanHtml = DOMPurify.sanitize(marked.parse(content.result));
                    resultDiv.innerHTML = cleanHtml;

                    // クッキーに保存
                    saveFormDataToCookies(formData);

                } catch (error) {
                    const errorMessage = error.name === 'SyntaxError' 
                    ? 'Invalid server response'
                    : error.message;
                    resultDiv.textContent = error.response ?
                     `エラー: ${error.message}` 
                    : `通信エラー: ${errorMessage}`;
                } finally {
                    submitButtons.forEach(btn => btn.disabled = false);
                    const spinner = document.getElementById(spinnerId);
                    if (spinner) spinner.style.display = 'none';
                }
            };

            // ボタン設定とイベントリスナーの登録
            const buttonConfigs = [
            { id: 'submit-button1', spinner: 'spinner1', sb: 1 },
            { id: 'submit-button2', spinner: 'spinner2', sb: 2 },
            { id: 'submit-button3', spinner: 'spinner3', sb: 3 },
            { id: 'submit-button4', spinner: 'spinner4', sb: 4 },
            { id: 'submit-button5', spinner: 'spinner5', sb: 5 },
            { id: 'submit-button6', spinner: 'spinner6', sb: 6 }
            ];

            buttonConfigs.forEach(({ id, spinner, sb }) => {
            const button = document.getElementById(id);
            if (button) {
                button.addEventListener('click', createSubmitHandler(sb, spinner));
            }
            });
        </script>
    

        <!-- (F) ホロスコープを生成・描画するスクリプト -->
        <script>
            // 惑星英名 => 惑星和名
            const planetNameMap = {
                "Sun"     : "太陽",
                "Moon"    : "月",
                "Mercury" : "水星",
                "Venus"   : "金星",
                "Mars"    : "火星",
                "Jupiter" : "木星",
                "Saturn"  : "土星",
                "Uranus"  : "天王星",
                "Neptune" : "海王星",
                "Pluto"   : "冥王星"
            };
            // 惑星英名 => シンボル
            const planetSymbolMap = {
                "Sun"     : "☉",
                "Moon"    : "☾",
                "Mercury" : "☿",
                "Venus"   : "♀",
                "Mars"    : "♂",
                "Jupiter" : "♃",
                "Saturn"  : "♄",
                "Uranus"  : "♅",
                "Neptune" : "♆",
                "Pluto"   : "♇"
            };
            // アスペクト色（高級感のある金・銀・深紅・濃緑・ダークゴールド）
            const aspectColorMap = {
                "コンジャンクション": "#FFD700",  // 明るいゴールド（ゴールド）
                "オポジション": "#0000FF",        // ブルー（青）
                "スクエア": "#FF6347",            // 明るいレッド（トマトレッド）
                "トライン": "#32CD32",            // 明るいグリーン（ライムグリーン）
                "セクスタイル": "#FFCC33",        // 明るいゴールデンロッド（ライトゴールデンロッド）
                "Conjunction": "#FFD700",
                "Opposition": "#0000FF",
                "Square": "#FF6347",
                "Trine": "#32CD32",
                "Sextile": "#FFCC33"
            };
            // 星座のシンボル
            const zodiacSymbols = {
                0: "♈", 1: "♉", 2: "♊", 3: "♋",
                4: "♌", 5: "♍", 6: "♎", 7: "♏",
                8: "♐", 9: "♑", 10: "♒", 11: "♓"
            };

            /**
             * ホロスコープを描画する関数
             * @param {Object} horoscopeData サーバー等から取得したホロスコープ情報
             */
            function drawHoroscopeWheel(horoscopeData) {
                const chartContainer = document.getElementById('chart-container');
                const canvas = document.getElementById('horoscope-canvas');

                // canvas のサイズ調整
                let containerWidth = chartContainer.offsetWidth; 
                if (containerWidth > 1000) {
                    containerWidth = 1000; 
                }
                canvas.width = containerWidth;
                canvas.height = containerWidth;
                chartContainer.style.width  = containerWidth + "px";
                chartContainer.style.height = containerWidth + "px";

                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius  = canvas.width * 0.4;

                // ハウスデータの処理（rotationOffset 等）
                const houseData = horoscopeData?.raw_data?.houses;
                let rotationOffset = 0;
                if (houseData && houseData.cusp && houseData.cusp.length > 0) {
                    const firstCuspDeg = houseData.cusp[0];
                    rotationOffset = (90 - firstCuspDeg) % 360;
                }
                function degToRad(deg) {
                    return (360 - (deg + rotationOffset) - 90) * Math.PI / 180;
                }

                // 背景グラデーション（中心から薄い青がかかるグラデーション）
                const bgGradient = ctx.createRadialGradient(
                    centerX, centerY, 0,
                    centerX, centerY, radius * 1.5
                );
                bgGradient.addColorStop(0,   "#f0f8ff");
                bgGradient.addColorStop(0.7, "#cceeff");
                bgGradient.addColorStop(1,   "#99bbff");
                ctx.fillStyle = bgGradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // 外円描画（ゴールドの外枠）
                ctx.save();
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius + 10, 0, 2 * Math.PI);
                ctx.shadowColor = 'rgba(30, 144, 255, 0.5)'; // 濃い青色のシャドウ
                ctx.shadowBlur = 10;
                ctx.strokeStyle = '#E0FFFF'; // プラチナシルバー
                ctx.lineWidth = 4;
                ctx.stroke();
                ctx.restore();

                // ハウス線とハウス番号（ハウス番号の色を黒に変更）
                if (houseData && houseData.cusp) {
                    for (let i = 0; i < houseData.cusp.length; i++) {
                        const cuspAngleDeg = houseData.cusp[i];
                        const angleRad = degToRad(cuspAngleDeg);

                        const x2 = centerX + (radius + 10) * Math.cos(angleRad);
                        const y2 = centerY + (radius + 10) * Math.sin(angleRad);

                        ctx.save();
                        ctx.beginPath();
                        ctx.moveTo(centerX, centerY);
                        ctx.lineTo(x2, y2);
                        ctx.strokeStyle = 'rgba(0, 0, 0, 0.5)'; // 黒
                        ctx.lineWidth = 1;
                        ctx.setLineDash([6, 4]); // 点線
                        ctx.stroke();
                        ctx.restore();

                        // ハウス番号を白で描画
                        const labelRadius = radius * 0.5;
                        const labelX = centerX + labelRadius * Math.cos(angleRad - 0.26);
                        const labelY = centerY + labelRadius * Math.sin(angleRad - 0.26);

                        ctx.save();
                        ctx.font = Math.floor(canvas.width * 0.025) + "px 'Times New Roman'";
                        ctx.fillStyle = "#000000"; // 黒
                        ctx.textAlign = "center";
                        ctx.textBaseline = "middle";
                        ctx.fillText((i + 1).toString(), labelX, labelY);
                        ctx.restore();
                    }
                }

                // ★ 惑星配置
                const planets = horoscopeData?.raw_data?.planets;
                if (!planets) {
                    alert("惑星データが見つかりません。");
                    return;
                }
                const planetPositions = {};
                // drawnSymbols 配列は adjust 関数用（シンボル位置の調整用）
                const drawnSymbols = [];
                // planetSymbolsToDraw 配列にシンボル描画情報を保存し、後で最前面に描画する
                const planetSymbolsToDraw = [];

                /**
                 * adjust 関数
                 * 惑星シンボル同士が重なっている場合、元の位置から offset ずらした位置を返し、
                 * その位置と元の位置を線分で結びます。
                 *
                 * @param {CanvasRenderingContext2D} ctx - canvas のコンテキスト
                 * @param {number} x - 元の x 座標
                 * @param {number} y - 元の y 座標
                 * @param {number} angle - 惑星配置の角度 (ラジアン)
                 * @param {Array} drawnSymbols - 既に描画済みのシンボルの位置リスト
                 * @returns {Object} 調整後の {x, y} 座標
                 */
                function adjust(ctx, x, y, angle, drawnSymbols) {
                    const offsetStep = 30;         // 30px ずつずらす
                    let offset = 0;
                    let newX = x;
                    let newY = y;
                    const collisionThreshold = 15; // 中心間距離が15px未満なら重なっていると判定

                    while (true) {
                        let collision = false;
                        for (let pos of drawnSymbols) {
                            const dx = pos.x - newX;
                            const dy = pos.y - newY;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            if (distance < collisionThreshold) {
                                collision = true;
                                break;
                            }
                        }
                        if (!collision) {
                            break;
                        }
                        offset += offsetStep;
                        newX = x - offset * Math.cos(angle);
                        newY = y - offset * Math.sin(angle);
                        // 無限ループ防止のための上限
                        if (offset > 100) break;
                    }

                    // ずらしが発生していた場合、元の位置と調整後の位置を線分で結ぶ
                    if (offset > 0) {
                        ctx.save();
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        ctx.lineTo(newX, newY);
                        ctx.strokeStyle = "rgba(255,255,255,0.5)";
                        ctx.lineWidth = 0.5;
                        ctx.stroke();
                        ctx.restore();
                    }
                    drawnSymbols.push({ x: newX, y: newY });
                    return { x: newX, y: newY };
                }

                // 各惑星の描画（惑星の円はそのまま描く）
                for (const planetName of Object.keys(planets)) {
                    const planetObj = planets[planetName];
                    if (planetObj.longitude === undefined) continue;
                    
                    let lonDeg = Array.isArray(planetObj.longitude)
                        ? planetObj.longitude[0]
                        : parseFloat(planetObj.longitude);
                    if (isNaN(lonDeg)) continue;
                    
                    const angleRad = degToRad(lonDeg);
                    const x = centerX + radius * Math.cos(angleRad);
                    const y = centerY + radius * Math.sin(angleRad);

                    // 惑星の円を描画（高級感のある色合い）
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(x, y, canvas.width * 0.008, 0, 2 * Math.PI);
                    let fillColor = '#dd3333';
                    switch (planetName) {
                        case 'Sun'     : fillColor = '#D4AF37'; break;  // ゴールド
                        case 'Moon'    : fillColor = '#C0C0C0'; break;  // シルバー
                        case 'Mercury' : fillColor = '#708090'; break;  // スレートグレー
                        case 'Venus'   : fillColor = '#B87333'; break;  // カッパー
                        case 'Mars'    : fillColor = '#8B0000'; break;  // ダークレッド
                        case 'Jupiter' : fillColor = '#CD7F32'; break;  // ブロンズ
                        case 'Saturn'  : fillColor = '#A67B5B'; break;  // ブロンズ系
                        case 'Uranus'  : fillColor = '#008080'; break;  // ティール
                        case 'Neptune' : fillColor = '#00008B'; break;  // ネイビー
                        case 'Pluto'   : fillColor = '#800080'; break;  // パープル
                    }
                    ctx.fillStyle = fillColor;
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.3)'; // 黒色のシャドウ
                    ctx.shadowBlur = 6;
                    ctx.fill();
                    ctx.restore();

                    // adjust 関数でシンボルの位置を調整（重なりがあれば線分も描画）
                    const symbol = planetSymbolMap[planetName] || planetName;
                    const adjustedPos = adjust(ctx, x, y, angleRad, drawnSymbols);
                    // ※ 惑星シンボルは黒で描画（fillStyle を "#000000" に変更）
                    planetSymbolsToDraw.push({
                        symbol: symbol,
                        x: adjustedPos.x,
                        y: adjustedPos.y,
                        font: Math.floor(canvas.width * 0.08) + "px sans-serif",
                        fillStyle: "#000000" // 黒
                    });

                    planetPositions[planetName] = { x, y };
                }

                // アスペクト描画
                const aspects = horoscopeData?.analysis?.["4.アスペクトの結果"] || [];
                aspects.forEach(aspect => {
                    const planet1Ja = aspect.planet1;
                    const planet2Ja = aspect.planet2;
                    const aspectName = aspect.aspect;
                    let p1En = null, p2En = null;
                    for (const [en, ja] of Object.entries(planetNameMap)) {
                        if (ja === planet1Ja) p1En = en;
                        if (ja === planet2Ja) p2En = en;
                    }
                    if (!p1En || !p2En) return;

                    const pos1 = planetPositions[p1En];
                    const pos2 = planetPositions[p2En];
                    if (!pos1 || !pos2) return;

                    let lineColor = aspectColorMap[aspectName] || "#AAAAAA"; // パステル調の色

                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(pos1.x, pos1.y);
                    ctx.lineTo(pos2.x, pos2.y);
                    ctx.strokeStyle = lineColor;
                    ctx.lineWidth = canvas.width * 0.002;
                    if (aspectName === "スクエア" || aspectName === "Square") {
                        ctx.setLineDash([5, 3]);
                    }
                    ctx.stroke();
                    ctx.restore();
                });

                const zodiacColors = [
                    "#FF0000", // Red (牡羊座)
                    "#808000", // Dark Yellow (牡牛座)　
                    "#008000", // Green (双子座)
                    "#0000FF", // Blue (蟹座)
                    "#FF0000", // Red (獅子座)
                    "#808000", // Dark Yellow (乙女座)　
                    "#008000", // Green (天秤座)
                    "#0000FF", // Blue (蠍座)
                    "#FF0000", // Red (射手座)
                    "#808000", // Dark Yellow (山羊座)　
                    "#008000", // Green (水瓶座)
                    "#0000FF", // Blue (魚座)
                ];

                // ★ 星座の区分線およびシンボルの描画（修正版）
                ctx.save();
                // 内側のホロスコープ円（radius）はそのまま利用
                // 内側の区分線の開始位置（ホロスコープ円から少し外側）
                const innerDividingRadius = radius + (canvas.width * 0.017);
                // 星座シンボルを描く半径（内側と外側の中間あたり）
                const zodiacSymbolRadius = radius + (canvas.width * 0.06);
                // 外側に描く大きな円の半径（星座シンボルの外側＋余白）
                const outerCircleRadius = zodiacSymbolRadius + (canvas.width * 0.03);
                
                for (let i = 0; i < 12; i++) {
                    // degToRad が反転しているので、開始角度と終了角度を入れ替えています
                    const startAngle = degToRad((i + 1) * 30);
                    const endAngle   = degToRad(i * 30);

                    ctx.beginPath();
                    // 外側円弧の開始点に移動
                    ctx.moveTo(
                        centerX + outerCircleRadius * Math.cos(startAngle),
                        centerY + outerCircleRadius * Math.sin(startAngle)
                    );
                    // 外側の円弧を描く（startAngle ～ endAngle）
                    ctx.arc(centerX, centerY, outerCircleRadius, startAngle, endAngle, false);
                    // 外側の円弧の終点と内側の円弧の開始点を直接結ぶ
                    ctx.lineTo(
                        centerX + innerDividingRadius * Math.cos(endAngle),
                        centerY + innerDividingRadius * Math.sin(endAngle)
                    );
                    // 内側の円弧を描く（endAngle ～ startAngle を逆方向に）
                    ctx.arc(centerX, centerY, innerDividingRadius, endAngle, startAngle, true);
                    // パスを閉じる（自動的に内側の円弧の終点と外側の円弧の開始点を結ぶ）
                    ctx.closePath();

                    // ctx.fillStyle = zodiacColors[i];
                    ctx.fill();
                }

                // ① 外側の大円の外周を描画（ゴールドのライン）
                ctx.beginPath();
                ctx.arc(centerX, centerY, outerCircleRadius, 0, 2 * Math.PI);
                ctx.strokeStyle = '#D4AF37';
                ctx.lineWidth = 4;
                ctx.stroke();

                // ② 星座区分線と星座シンボルの描画
                for (let i = 0; i < 12; i++) {
                    // 各星座の境界線の角度（0～360°）
                    const lineAngle = degToRad(i * 30);
                    // 区分線は内側（innerDividingRadius）から外側の大円（outerCircleRadius）まで
                    ctx.beginPath();
                    ctx.moveTo(
                        centerX + innerDividingRadius * Math.cos(lineAngle),
                        centerY + innerDividingRadius * Math.sin(lineAngle)
                    );
                    ctx.lineTo(
                        centerX + outerCircleRadius * Math.cos(lineAngle),
                        centerY + outerCircleRadius * Math.sin(lineAngle)
                    );
                    ctx.strokeStyle = "rgba(50, 50, 50, 0.8)"; // 濃いグレー
                    ctx.lineWidth = 1;
                    ctx.stroke();

                    // 星座シンボルは区分線の中央あたりに配置（色を黒に変更）
                    const midAngleRad = degToRad(i * 30 + 15);
                    // シンボルを配置する半径は内側と外側の中間
                    const symbolRadius = (innerDividingRadius + outerCircleRadius) / 2;
                    const textX = centerX + symbolRadius * Math.cos(midAngleRad);
                    const textY = centerY + symbolRadius * Math.sin(midAngleRad);

                    ctx.save();
                    ctx.translate(textX, textY);
                    ctx.font = Math.floor(canvas.width * 0.05) + "px 'Arial Rounded MT Bold'"; // Arial Rounded MT Bold風フォント
                    ctx.fillStyle = "#000000";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(zodiacSymbols[i], 0, 0);
                    ctx.restore();
                }
                ctx.restore();

                // ★ 最後に、保存しておいた惑星シンボルを再描画して最前面に表示（色を黒に変更）
                planetSymbolsToDraw.forEach(item => {
                    ctx.save();
                    ctx.font = item.font;
                    ctx.fillStyle = item.fillStyle;
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(item.symbol, item.x, item.y);
                    ctx.restore();
                });
            }
        </script>


        <!-- (G) 「ホロスコープを作成」ボタンの処理 (本番データで描画) -->
        <script>
            document.getElementById('draw-button').addEventListener('click', async function() {
                // (1) フォームの入力からパラメータを生成
                const form = document.getElementById('horoscope-form');
                const formData = new FormData(form);
                const year  = formData.get('year');
                const month = formData.get('month');
                const day   = formData.get('day');
                const time  = formData.get('time') || "12:00";
                const lat   = formData.get('lat');
                const lon   = formData.get('lon');
                const tz    = formData.get('tz');
                const dst   = formData.get('dst');
    
                // 不明時刻の場合は hour, minute = '12:00' などで補正
                const [hour, minute] = time.split(':');
    
                // クエリパラメータを作成 (Django想定の例)
                const params = new URLSearchParams({
                    year, month, day,
                    hour, minute,
                    lat, lon,
                    tz, dst
                });
                // 例: /horoscope_app/horoscope/?year=...&month=... など
                // 実際のURLはサーバー側に合わせて修正してください
                const horoscopeUrl = "{% url 'horoscope_app:horoscope' %}?" + params.toString();
    
                // (2) fetch でサーバーからホロスコープデータを取得
                try {
                    const response = await fetch(horoscopeUrl, {
                        method: 'GET',
                    });
                    if (!response.ok) {
                        throw new Error("ホロスコープデータの取得に失敗しました");
                    }
    
                    const horoscopeData = await response.json();
    
                    // (3) モーダルを表示後、実際に描画
                    const chartContainer = document.getElementById('chart-container');
                    chartContainer.style.display = 'block';
                    drawHoroscopeWheel(horoscopeData);
                    saveFormDataToCookies(formData);
    
                } catch (err) {
                    alert(err.message);
                }
            });
        </script>
        <!-- 詳細画面へリンク -->
        <script>
            document.getElementById('view-button').addEventListener('click', function() {
            const form = document.getElementById('horoscope-form');
            const formData = new FormData(form);
            const year  = formData.get('year');
            const month = formData.get('month');
            const day   = formData.get('day');
            const time  = formData.get('time') || "12:00";
            const lat   = formData.get('lat');
            const lon   = formData.get('lon');
            const tz    = formData.get('tz');
            const dst   = formData.get('dst');
        
            const [hour, minute] = time.split(':');
        
            const params = new URLSearchParams({
                year, month, day,
                hour, minute,
                lat, lon,
                tz, dst
            });
            
            saveFormDataToCookies(formData);

            const horoscopeUrl = "{% url 'horoscope_app:horoscope_detail' %}?" + params.toString();
            window.location.href = horoscopeUrl;
            });
        </script>
        <!-- 保存ボタン -->
        <script>
            function saveCanvasAsImage() {
            const canvas = document.getElementById('horoscope-canvas');
            const link = document.createElement('a');
            link.download = 'horoscope.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            }
        </script>
  
    </body>
</html>
