{% load static %}
<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <!-- ★レスポンシブ対応の viewport 指定 -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- SEO用 meta タグ -->
        <meta name="description" content="AI占星術師アオポンによる二人の相性占いサービス。生年月日、出生時刻、出生地から二人のホロスコープを作成し、相性を占います。">
        <meta name="keywords" content="ホロスコープ, ホロスコープ作成, 占星術, AI占星術, 二人の相性占い">
        <meta name="robots" content="index, follow">
        
        <!-- Canonical タグ（URLが確定している場合） -->
        <link rel="canonical" href="https://aihoroscopeanalysis.com/compatibility">

        <!-- OGPタグ（SNS等でのシェア用） -->
        <meta property="og:title" content="二人の相性占い - AI占星術師アオポン">
        <meta property="og:description" content="生年月日、出生時刻、出生地から二人のホロスコープを作成し、相性を占います。">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://aihoroscopeanalysis.com/compatibility">
        <meta property="og:image" content="{% static 'path/to/horoscope-demo8.png' %}">

        <!-- JSON-LDによる構造化データ -->
        <script type="application/ld+json">
        {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "name": "二人の相性占い - AI占星術師アオポン",
        "description": "生年月日、出生時刻、出生地から二人のホロスコープを作成し、相性を占います。",
        "url": "https://aihoroscopeanalysis.com/compatibility"
        }
        </script>

        <title>二人の相性占い - AI占星術師アオポン</title>
        
        <!-- Marked.jsのUMDビルドを読み込む -->
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <!-- DOMPurifyを読み込む（セキュリティ対策） -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.10/purify.min.js"></script>
        
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-V8QL89EXFC"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-V8QL89EXFC');
        </script>

        <script type="text/javascript">
            (function(c,l,a,r,i,t,y){
                c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
                t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
                y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
            })(window, document, "clarity", "script", "q3kqriyub6");
        </script>
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9717699132149345"
        crossorigin="anonymous"></script>
        
        <style>
            /* 全体リセット・ベース設定 */
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            body {
                /* 例：Google Fonts 等で 'Merriweather' や 'Playfair Display' を読み込んだ上で */
                font-family: 'Merriweather', serif;
                margin: 0;
                background: linear-gradient(135deg, #fdfbfb, #ebedee);
            }

            /* ヘッダー */
            h1 {
                background: linear-gradient(90deg, #2c3e50, #4ca1af);
                color: #fff;
                padding: 20px;
                text-align: center;
                margin: 0;
                width: 100%;
                font-family: 'Playfair Display', serif;  /* 上質な印象のセリフ体 */
                text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            }

            /* メインコンテナー */
            .content-container {
                display: flex; 
                justify-content: space-between;
                gap: 20px;
                padding: 0px;
                /* 画面が狭いときは縦並びに */
                flex-wrap: wrap;
            }

            /* フォーム全体 */
            #horoscope-form {
                flex: 1;
                max-width: 100%;
                background-color: #fff;
                padding: 30px;
                border-radius: 12px;
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
                border: 1px solid #e0e0e0;
            }

            /* テーブルのスタイル */
            #horoscope-form table {
                width: 100%;
                border-collapse: collapse;
            }
            #horoscope-form th, 
            #horoscope-form td {
                padding: 16px 20px;
                border: none;
                border-bottom: 1px solid #e0e0e0;
                text-align: left;
                vertical-align: middle;
            }
            #horoscope-form th {
                background-color: transparent;
                color: #333;
                font-weight: bold;
            }
            #horoscope-form td {
                background-color: #fff;
            }

            /* input, select */
            input, select {
                width: 32%;
                padding: 8px;
                margin-top: 5px;
                box-sizing: border-box;
            }
            input,select {
            /* 高さを小さく設定 */
            height: 30px;
            line-height: 30px;
            
            /* 内側の余白 */
            padding: 0px;
            
            /* フォントサイズ */
            font-size: 16px;
            
            /* 枠線・角丸 */
            border: 1px solid #ccc;
            border-radius: 5px;
            
            /* 背景色 */
            background-color: #fff;
            
            /* iOS等でのデフォルトのスタイル（矢印など）を解除 */
            /* appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none; */
            
            /* レンダリングのためにボックスサイズを指定 */
            box-sizing: border-box;
            }
            #horoscope-form input[type="time"] {
                width: auto; 
                min-width: 100px;
            }

            /* 共通ボタンスタイルの変更 */
            button {
                margin-top: 20px;
                padding: 12px 24px;
                cursor: pointer;
                border-radius: 8px;
                font-size: 16px;
                border: none;
                transition: all 0.3s ease;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }
            button:hover:not(:disabled) {
                filter: brightness(95%);
                transform: translateY(-2px);
            }

            /* 各ボタンのカラー例 */
            #submit-button7,
            #submit-button8 {
                background: linear-gradient(45deg, #2c3e50, #4ca1af); /* 高級感あるグラデーション */
                color: #fff;
                padding: 14px 28px;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: bold;
                text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                transition: transform 0.3s ease, filter 0.3s ease;
            }

            /* スピナーのスタイル */
            .spinner {
                border: 4px solid rgba(0, 0, 0, 0.1);
                border-top: 4px solid #4CAF50; 
                border-radius: 50%;
                width: 24px;
                height: 24px;
                animation: spin 1s linear infinite;
                display: inline-block;
                vertical-align: middle;
                margin-left: 10px;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            /* 結果表示のスタイル */
            #result,
            .result-sample {
                margin-top: 30px;
                padding: 15px;
                border: 1px solid #ccc;
                background-color: #f9f9f9;
                white-space: pre-line;
                font-size: 16px;
                color: #333;
            }
            /* resultDiv 内のリストのスタイルを調整 */
            #result ol,
            #result ul,
            .result-sample ol,
            .result-sample ul {
                margin-left: 1.5em;  /* 必要に応じて数値を調整 */
                padding-left: 0;
            }
            .horoscope-meaning ul {
                margin-left: 1.5em;  /* 必要に応じて数値を調整 */
                padding-left: 0;
            }

            /* エラーメッセージのスタイル */
            #error-message {
                color: red;
                margin-top: 10px;
            }

            /* 小さい説明文 */
            small {
                display: block;
                margin-top: 5px;
                color: #666;
            }

            /* テーブル配置用のラッパ */
            #container-table {
                margin: auto;
                width: 100%;
                max-width: 1000px;
            }

            /**
            * ホロスコープ描画用のコンテナ
            * ここを JavaScript 側で width/height を同じに設定します。
            */
            #chart-container {
                position: relative; /* 惑星ラベルを absolute 配置するため */
                margin: 0 auto;
                /* margin-bottom: 10px; */
                /* CSS 側では width/height を固定しない: JS で動的にセット */
                border: 1px solid #ccc;
                display: none; /* 最初は非表示 */
            }

            /* canvas はJSで (最大1000 x 1000) にします */
            #horoscope-canvas {
                display: block; /* ブロック要素化 */
                width: 100%;    /* ここで #chart-container と同じ幅にフィット */
                height: 100%;   /* 同上 */
                background: #99bbff;
            }

            
            /* モーダル関連 */
            .modal {
                display: none;
                position: fixed; 
                z-index: 1000; 
                left: 0;
                top: 0;
                width: 100%; 
                height: 100%; 
                overflow: auto; 
                background-color: rgba(0, 0, 0, 0.5); 
            }
            .modal-content {
                background-color: #fff;
                margin: 10% auto;
                padding: 5px;
                border: none;
                width: 80%;
                max-width: 700px;
                position: relative;
                border-radius: 12px;
                box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            }
            
            /* モーダル開閉ボタン */
            .open-modal-btn {
                background: linear-gradient(45deg, #2c3e50, #4ca1af); /* 高級感あるグラデーション */
                color: #fff;
                padding: 5px 10px;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: bold;
                text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                transition: transform 0.3s ease, filter 0.3s ease;
            }

            .open-modal-btn:hover {
                filter: brightness(95%);
                transform: translateY(-2px);
            }

            /* インプットやチェックボックスを横並びにする簡易レイアウト */
            .input-group {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .checkbox-label {
                display: flex;
                white-space: nowrap;
                gap: 4px;
            }

            /* ★ レスポンシブ（画面幅が768px以下の場合） */
            @media (max-width: 768px) {
                h1 {
                    font-size: 1.2em;
                    padding: 15px;
                }
                .content-container {
                    flex-direction: column;
                    align-items: center;
                }
                #container-table {
                    width: 100%;
                    max-width: 100%;
                }
                #horoscope-form th, 
                #horoscope-form td {
                    padding: 8px;
                    font-size: 0.9em;
                }
                .modal-content {
                    margin: 30% auto 0;
                    width: 90%;
                }
            }
            /* 全体コンテナ */
            .horoscope-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 10px;
            }

            /* ホロスコープ作成ボタン */
            .horoscope-create {
            text-align: center;
            }

            /* コンテナのスタイル */
            .analysis-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            /* 各ボタン共通のスタイル */
            .analysis-button button {
                padding: 10px 20px;
                font-size: 16px;
                border: none;
                border-radius: 5px;
                color: #fff;
                cursor: pointer;
                transition: background-color 0.3s ease, filter 0.3s ease;
            }
            .analysis-buttons {
            display: flex;
            justify-content: space-evenly; /* 均等にスペースを空ける */
            align-items: center; /* 垂直方向の中央揃え */
            }

            /* 各ボタンを同じ幅にしたい場合 */
            .analysis-button {
            flex: 1;                   /* 各要素の幅を均等に */
            display: flex;
            justify-content: center;   /* 内部のボタンを中央寄せ */
            }
            
            
            /* ホバー時：少し暗めに */
            .analysis-button button:hover:not(:disabled) {
                filter: brightness(90%);
            }
            
            /* disabled状態のスタイル */
            .analysis-button button:disabled {
                background-color: #ddd;
                color: #aaa;
                cursor: not-allowed;
            }
            

            /* 初期状態で非表示のスピナー */
            .spinner {
            display: none;
            }

            
            html, body {
            height: 100%;
            margin: 0;
            }
            @media (max-width: 768px) {
            .analysis-buttons {
                /* 2列レイアウトのため、横並びにして折り返しを許可 */
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: space-between; /* ボタン間のスペースを調整 */
            }
            .analysis-button {
                /* 各ボタンの幅を2列分に（gap分を引いた値） */
                min-width: calc(50% - 10px);
                margin-bottom: 10px;
            }
            }
            /* ページ全体をラップするコンテナ */
            .wrapper {
            flex-direction: column;
            min-height: 100%;
            }
            /* コンテンツエリアは空いたスペースをすべて使う */
            .content {
            flex: 1;
            padding: 0px;
            }
            /* フッター（広告）のスタイル */
            .footer {
            background-color: #f9f9f9;
            text-align: center;
            padding: 10px 0;
            }
            /* 広告バナー全体のスタイル（中央寄せなど） */
            #ad-banner {
            text-align: center;
            margin: 20px auto;
            }
            /* デフォルトではデスクトップ広告を表示 */
            .desktop-ad {
            display: block;
            }
            .mobile-ad {
            display: none;
            }
            /* 画面幅が768px以下の場合はモバイル広告に切り替え */
            @media screen and (max-width: 768px) {
            .desktop-ad {
                display: none;
            }
            .mobile-ad {
                display: block;
            }
            }
            /* 3カラムレイアウト用のスタイル */
            .layout-wrapper {
            display: flex;
            justify-content: center; /* 中央寄せ */
            align-items: flex-start;
            gap: 20px; /* 広告と中央コンテンツの間の隙間 */
            max-width: 1600px; /* コンテンツ全体の最大幅 */
            margin: 0 auto;
            padding: 0px;
            }

            /* 広告エリアのスタイル */
            .side-ad {
            flex: 0 0 250px; /* 固定幅 160px（必要に応じて調整） */
            }

            /* 中央コンテンツエリア */
            .main-content {
            flex: 1;
            background-color: transparent;
            padding: 0px;
            /* border-radius: 12px; */
            /* box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); */
            /* border: 1px solid #e0e0e0; */
            }

            /* レスポンシブ対応：画面幅が768px以下の場合は広告を非表示に */
            @media (max-width: 768px) {
            .layout-wrapper {
                flex-direction: column;
                padding: 10px;
            }
            .side-ad {
                display:flexbox;
            }
            .main-content {
                width: 100%;
            }
            /* 左寄せのサイドバー用（必要に応じて調整） */
            .left-ad {
            float: left;
            width: 100%;                   /* 幅は調整可能 */
            }
            }
            /* サイドバー全体のスタイル */
            .side-ad {
            background-color: #f7f7f7;      /* やわらかい背景色 */
            border: 1px solid #ddd;         /* 薄い枠線 */
            padding: 15px;
            border-radius: 8px;             /* 角を丸く */
            margin: 10px;
            font-family: 'Arial', sans-serif;
            }

            /* 左寄せのサイドバー用（必要に応じて調整） */
            .left-ad {
            float: left;
            /* width: 250px; */
            }

            /* リスト全体のリセット */
            .ad-content ul {
            list-style: none;               /* デフォルトのマーカーを非表示 */
            margin: 0;
            padding: 0;
            }

            /* 各リストアイテムの間隔 */
            .ad-content ul li {
            margin-bottom: 10px;
            }

            /* リンクのスタイル */
            .ad-content ul li a {
            display: block;                 /* リンク全体をブロック要素に */
            text-decoration: none;          /* 下線なし */
            color: #333;
            font-weight: bold;
            padding: 8px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: background-color 0.3s, color 0.3s;
            }

            /* リンクホバー時のスタイル */
            .ad-content ul li a:hover {
            background-color: #e9e9e9;
            color: #000;
            }

            img {
            max-width: 100%;
            height: auto;
            }
            .container {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            }
            .form-section {
            width: 60%;
            }
            /* 親要素にFlexboxレイアウトを適用 */
            .container {
            display: flex;
            align-items: flex-start; /* 上揃え */
            gap: 20px;
            padding: 20px;
            }
            
            /* 左側：フォーム部分 */
            .form-section {
                flex: 0 0 auto;
            }
            
            .canvas-section {
                width: 40%;
            }
            
            /* キャンバスは初期サイズを400pxとしつつ、親要素に合わせて縮小 */
            canvas {
            width: 386px;
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
            }
            
            /* 画面幅が768px以下の場合は縦並びに変更 */
            @media (max-width: 768px) {
            .container {
                flex-direction: column;
                align-items: center;
            }
            
            .form-section,
            .canvas-section {
                width: 100%;
            }
            
            /* 必要に応じてフォーム部分の最大幅を指定 */
            .form-section {
                max-width: 400px;
            }
            }
            /* CSS */
            .container-wrapper {
            display: column;         /* 横並びにする */
            justify-content: space-between; /* 必要に応じてスペース調整 */
            gap: 20px;             /* コンテナー間に隙間を作る（オプション） */
            }

            .container {
            flex: 1;               /* 各コンテナーを均等に配置する */
            box-sizing: border-box; /* パディング等を含めた幅の計算 */
            /* 必要に応じて最大幅や最小幅を指定 */
            }
        </style>
    </head>
    
    <body>
        <div class="wrapper">
            <h1>二人の相性占い - AI占星術師アオポン</h1>
            <div class="layout-wrapper">
                <aside class="side-ad left-ad">
                    <div class="ad-content">
                        <h3>メニュー</h3>
                        <ul>
                            <li><a href="{% url 'horoscope_app:index' %}">無料ホロスコープ作成・占い</a></li>
                            <li><a href="#main">二人の相性占い</a></li>
                            <li><a href="#howtouse">利用方法</a></li>
                            <li><a href="#horoscope-sample">ホロスコープのサンプル（真美子夫人）</a></li>
                            <li><a href="#analysis-sample1">AIによる分析結果のサンプル（大谷翔平さんと真美子夫人）二人の相性</a></li>
                            <li><a href="#analysis-sample2">AIによる分析結果のサンプル（大谷翔平さんと真美子夫人）二人の今後</a></li>
                            <li><a href="#horoscope-meaning">コラム ホロスコープの意味するところ</a></li>
                        </ul>
                        <a href="https://px.a8.net/svt/ejp?a8mat=44YPZF+3DGHQA+3QW4+5Z6WX" rel="nofollow">
                            <img border="0" width="234" height="60" alt="" src="https://www21.a8.net/svt/bgt?aid=250203147204&wid=003&eno=01&mid=s00000017482001004000&mc=1"></a>
                            <img border="0" width="1" height="1" src="https://www11.a8.net/0.gif?a8mat=44YPZF+3DGHQA+3QW4+5Z6WX" alt="">
                        <a href="https://px.a8.net/svt/ejp?a8mat=44YQRN+23M45E+2VYS+6NETT" rel="nofollow">
                            <img border="0" width="234" height="60" alt="" src="https://www22.a8.net/svt/bgt?aid=250204163127&wid=003&eno=01&mid=s00000013474001117000&mc=1"></a>
                            <img border="0" width="1" height="1" src="https://www14.a8.net/0.gif?a8mat=44YQRN+23M45E+2VYS+6NETT" alt="">
                        <h3>おすすめ書籍</h3>
                        <ul>
                            <li><a href="https://amzn.to/3WL4DBg">CD-ROM付き いちばんやさしい西洋占星術入門</a></li>
                            <li><a href="https://amzn.to/4guj9V3">五十六謀星もっちぃの西洋占星術講義</a></li>
                            <li><a href="https://amzn.to/3WO5wsV">基礎からわかる 西洋占星術の完全独習: 星々の導きで運命をたどる旅</a></li>
                        </ul>
                    </div>
                </aside>
                <!-- 中央メインコンテンツエリア -->
                <main class="main-content">
                    <!-- コンテンツエリア -->
                    <div class="content">
                        <div class="content-container">
                            
                            <div id="data" style="width: 100%;">
                                <a id="main"></a>
                                <form id="horoscope-form" method="POST" action="#">
                                    {% csrf_token %}
                                    <div class="container-wrapper">
                                        <div class="container">
                                            <div class="form-section">
                                                <div>あなた</div>
                                                <table>
                                                    <tbody>
                                                        <tr>
                                                            <th>生年月日</th>
                                                            <td>
                                                                <select name="year1" id="year-select1">
                                                                    {% for year in years %}
                                                                        <option value="{{ year }}">{{ year }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                                <select name="month1" id="month-select1">
                                                                    {% for month in months %}
                                                                        <option value="{{ month }}">{{ month }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                                <select name="day1" id="day-select1">
                                                                    {% for day in days %}
                                                                        <option value="{{ day }}">{{ day }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <th>出生時刻</th>
                                                            <td>
                                                                <div class="input-group">
                                                                    <input type="time" id="time1" name="time1" required />
                                                                    <label for="unknown1" class="checkbox-label">
                                                                        <input type="checkbox" id="unknown1" name="unknown1" />
                                                                        <span style="display: inline;">時刻不明</span>
                                                                    </label>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <th>出生地</th>
                                                            <td>
                                                                <select name="prefecture1" id="prefecture1">
                                                                    <option value="Hokkaido" data-lat="43.06417" data-lon="141.34694">北海道</option>
                                                                    <option value="Aomori" data-lat="40.82444" data-lon="140.74">青森県</option>
                                                                    <option value="Iwate" data-lat="39.70361" data-lon="141.1525">岩手県</option>
                                                                    <option value="Miyagi" data-lat="38.26889" data-lon="140.87194">宮城県</option>
                                                                    <option value="Akita" data-lat="39.71861" data-lon="140.1025">秋田県</option>
                                                                    <option value="Yamagata" data-lat="38.24056" data-lon="140.36333">山形県</option>
                                                                    <option value="Fukushima" data-lat="37.75" data-lon="140.46778">福島県</option>
                                                                    <option value="Ibaraki" data-lat="36.34139" data-lon="140.44667">茨城県</option>
                                                                    <option value="Tochigi" data-lat="36.56583" data-lon="139.88361">栃木県</option>
                                                                    <option value="Gunma" data-lat="36.39111" data-lon="139.06083">群馬県</option>
                                                                    <option value="Saitama" data-lat="35.85694" data-lon="139.64889">埼玉県</option>
                                                                    <option value="Tokyo" data-lat="35.6895" data-lon="139.6917" selected>東京都</option>
                                                                    <option value="Chiba" data-lat="35.60506" data-lon="140.12333">千葉県</option>
                                                                    <option value="Kanagawa" data-lat="35.44778" data-lon="139.6425">神奈川県</option>
                                                                    <option value="Niigata" data-lat="37.90222" data-lon="139.02361">新潟県</option>
                                                                    <option value="Toyama" data-lat="36.69529" data-lon="137.21134">富山県</option>
                                                                    <option value="Ishikawa" data-lat="36.59444" data-lon="136.62556">石川県</option>
                                                                    <option value="Fukui" data-lat="36.06528" data-lon="136.22194">福井県</option>
                                                                    <option value="Yamanashi" data-lat="35.66389" data-lon="138.56833">山梨県</option>
                                                                    <option value="Nagano" data-lat="36.65139" data-lon="138.18111">長野県</option>
                                                                    <option value="Gifu" data-lat="35.39111" data-lon="136.72222">岐阜県</option>
                                                                    <option value="Shizuoka" data-lat="34.97694" data-lon="138.38306">静岡県</option>
                                                                    <option value="Aichi" data-lat="35.18028" data-lon="136.90667">愛知県</option>
                                                                    <option value="Mie" data-lat="34.73028" data-lon="136.50859">三重県</option>
                                                                    <option value="Shiga" data-lat="35.00444" data-lon="135.86833">滋賀県</option>
                                                                    <option value="Kyoto" data-lat="35.02139" data-lon="135.75556">京都府</option>
                                                                    <option value="Osaka" data-lat="34.68639" data-lon="135.52">大阪府</option>
                                                                    <option value="Hyogo" data-lat="34.69139" data-lon="135.18306">兵庫県</option>
                                                                    <option value="Nara" data-lat="34.68528" data-lon="135.83278">奈良県</option>
                                                                    <option value="Wakayama" data-lat="34.22611" data-lon="135.1675">和歌山県</option>
                                                                    <option value="Tottori" data-lat="35.50361" data-lon="134.23833">鳥取県</option>
                                                                    <option value="Shimane" data-lat="35.47222" data-lon="133.05056">島根県</option>
                                                                    <option value="Okayama" data-lat="34.66167" data-lon="133.935">岡山県</option>
                                                                    <option value="Hiroshima" data-lat="34.39639" data-lon="132.45962">広島県</option>
                                                                    <option value="Yamaguchi" data-lat="34.18583" data-lon="131.47139">山口県</option>
                                                                    <option value="Tokushima" data-lat="34.06583" data-lon="134.55944">徳島県</option>
                                                                    <option value="Kagawa" data-lat="34.34028" data-lon="134.04333">香川県</option>
                                                                    <option value="Ehime" data-lat="33.84167" data-lon="132.76556">愛媛県</option>
                                                                    <option value="Kochi" data-lat="33.55972" data-lon="133.53108">高知県</option>
                                                                    <option value="Fukuoka" data-lat="33.60639" data-lon="130.41806">福岡県</option>
                                                                    <option value="Saga" data-lat="33.24944" data-lon="130.29889">佐賀県</option>
                                                                    <option value="Nagasaki" data-lat="32.74472" data-lon="129.87361">長崎県</option>
                                                                    <option value="Kumamoto" data-lat="32.78972" data-lon="130.74167">熊本県</option>
                                                                    <option value="Oita" data-lat="33.23806" data-lon="131.6125">大分県</option>
                                                                    <option value="Miyazaki" data-lat="31.91111" data-lon="131.42389">宮崎県</option>
                                                                    <option value="Kagoshima" data-lat="31.56028" data-lon="130.55806">鹿児島県</option>
                                                                    <option value="Okinawa" data-lat="26.2125" data-lon="127.68111">沖縄県</option>
                                                                </select>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                                <button type="button" id="draw-button1" class="open-modal-btn">ホロスコープを作成</button>
                                                <button type="button" id="view-button1" class="open-modal-btn">ホロスコープの詳細</button>
                                            </div>
                                            
                                            <div class="canvas-section">
                                                <div id="chart-container1">
                                                    <canvas id="horoscope-canvas1"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- 緯度/経度 (自動セット) -->
                                        <input type="hidden" step="0.0001" name="lat1" id="lat1" required readonly>
                                        <input type="hidden" step="0.0001" name="lon1" id="lon1" required readonly>
                                        <input type="hidden" step="0.1" name="tz1" required value="9.0">
                                        <input type="hidden" step="0.1" name="dst1" required value="0.0">
                                        <div id="error-message"></div>
                                        <div class="container">
                                            <div class="form-section">
                                                <div>お相手</div>
                                                <table>
                                                    <tbody>
                                                        <tr>
                                                            <th>生年月日</th>
                                                            <td>
                                                                <select name="year2" id="year-select2">
                                                                    {% for year in years %}
                                                                        <option value="{{ year }}">{{ year }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                                <select name="month2" id="month-select2">
                                                                    {% for month in months %}
                                                                        <option value="{{ month }}">{{ month }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                                <select name="day2" id="day-select2">
                                                                    {% for day in days %}
                                                                        <option value="{{ day }}">{{ day }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <th>出生時刻</th>
                                                            <td>
                                                                <div class="input-group">
                                                                    <input type="time" id="time2" name="time2" required />
                                                                    <label for="unknown2" class="checkbox-label">
                                                                        <input type="checkbox" id="unknown2" name="unknown2" />
                                                                        <span style="display: inline;">時刻不明</span>
                                                                    </label>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <th>出生地</th>
                                                            <td>
                                                                <select name="prefecture2" id="prefecture2">
                                                                    <option value="Hokkaido" data-lat="43.06417" data-lon="141.34694">北海道</option>
                                                                    <option value="Aomori" data-lat="40.82444" data-lon="140.74">青森県</option>
                                                                    <option value="Iwate" data-lat="39.70361" data-lon="141.1525">岩手県</option>
                                                                    <option value="Miyagi" data-lat="38.26889" data-lon="140.87194">宮城県</option>
                                                                    <option value="Akita" data-lat="39.71861" data-lon="140.1025">秋田県</option>
                                                                    <option value="Yamagata" data-lat="38.24056" data-lon="140.36333">山形県</option>
                                                                    <option value="Fukushima" data-lat="37.75" data-lon="140.46778">福島県</option>
                                                                    <option value="Ibaraki" data-lat="36.34139" data-lon="140.44667">茨城県</option>
                                                                    <option value="Tochigi" data-lat="36.56583" data-lon="139.88361">栃木県</option>
                                                                    <option value="Gunma" data-lat="36.39111" data-lon="139.06083">群馬県</option>
                                                                    <option value="Saitama" data-lat="35.85694" data-lon="139.64889">埼玉県</option>
                                                                    <option value="Tokyo" data-lat="35.6895" data-lon="139.6917" selected>東京都</option>
                                                                    <option value="Chiba" data-lat="35.60506" data-lon="140.12333">千葉県</option>
                                                                    <option value="Kanagawa" data-lat="35.44778" data-lon="139.6425">神奈川県</option>
                                                                    <option value="Niigata" data-lat="37.90222" data-lon="139.02361">新潟県</option>
                                                                    <option value="Toyama" data-lat="36.69529" data-lon="137.21134">富山県</option>
                                                                    <option value="Ishikawa" data-lat="36.59444" data-lon="136.62556">石川県</option>
                                                                    <option value="Fukui" data-lat="36.06528" data-lon="136.22194">福井県</option>
                                                                    <option value="Yamanashi" data-lat="35.66389" data-lon="138.56833">山梨県</option>
                                                                    <option value="Nagano" data-lat="36.65139" data-lon="138.18111">長野県</option>
                                                                    <option value="Gifu" data-lat="35.39111" data-lon="136.72222">岐阜県</option>
                                                                    <option value="Shizuoka" data-lat="34.97694" data-lon="138.38306">静岡県</option>
                                                                    <option value="Aichi" data-lat="35.18028" data-lon="136.90667">愛知県</option>
                                                                    <option value="Mie" data-lat="34.73028" data-lon="136.50859">三重県</option>
                                                                    <option value="Shiga" data-lat="35.00444" data-lon="135.86833">滋賀県</option>
                                                                    <option value="Kyoto" data-lat="35.02139" data-lon="135.75556">京都府</option>
                                                                    <option value="Osaka" data-lat="34.68639" data-lon="135.52">大阪府</option>
                                                                    <option value="Hyogo" data-lat="34.69139" data-lon="135.18306">兵庫県</option>
                                                                    <option value="Nara" data-lat="34.68528" data-lon="135.83278">奈良県</option>
                                                                    <option value="Wakayama" data-lat="34.22611" data-lon="135.1675">和歌山県</option>
                                                                    <option value="Tottori" data-lat="35.50361" data-lon="134.23833">鳥取県</option>
                                                                    <option value="Shimane" data-lat="35.47222" data-lon="133.05056">島根県</option>
                                                                    <option value="Okayama" data-lat="34.66167" data-lon="133.935">岡山県</option>
                                                                    <option value="Hiroshima" data-lat="34.39639" data-lon="132.45962">広島県</option>
                                                                    <option value="Yamaguchi" data-lat="34.18583" data-lon="131.47139">山口県</option>
                                                                    <option value="Tokushima" data-lat="34.06583" data-lon="134.55944">徳島県</option>
                                                                    <option value="Kagawa" data-lat="34.34028" data-lon="134.04333">香川県</option>
                                                                    <option value="Ehime" data-lat="33.84167" data-lon="132.76556">愛媛県</option>
                                                                    <option value="Kochi" data-lat="33.55972" data-lon="133.53108">高知県</option>
                                                                    <option value="Fukuoka" data-lat="33.60639" data-lon="130.41806">福岡県</option>
                                                                    <option value="Saga" data-lat="33.24944" data-lon="130.29889">佐賀県</option>
                                                                    <option value="Nagasaki" data-lat="32.74472" data-lon="129.87361">長崎県</option>
                                                                    <option value="Kumamoto" data-lat="32.78972" data-lon="130.74167">熊本県</option>
                                                                    <option value="Oita" data-lat="33.23806" data-lon="131.6125">大分県</option>
                                                                    <option value="Miyazaki" data-lat="31.91111" data-lon="131.42389">宮崎県</option>
                                                                    <option value="Kagoshima" data-lat="31.56028" data-lon="130.55806">鹿児島県</option>
                                                                    <option value="Okinawa" data-lat="26.2125" data-lon="127.68111">沖縄県</option>
                                                                </select>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                                <button type="button" id="draw-button2" class="open-modal-btn">ホロスコープを作成</button>
                                                <button type="button" id="view-button2" class="open-modal-btn">ホロスコープの詳細</button>
                                            </div>
                                            
                                            <div class="canvas-section">
                                                <div id="chart-container2">
                                                    <canvas id="horoscope-canvas2"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- 緯度/経度 (自動セット) -->
                                        <input type="hidden" step="0.0001" name="lat2" id="lat2" required readonly>
                                        <input type="hidden" step="0.0001" name="lon2" id="lon2" required readonly>
                                        <input type="hidden" step="0.1" name="tz2" required value="9.0">
                                        <input type="hidden" step="0.1" name="dst2" required value="0.0">
                                        <div id="error-message"></div>
                                    </div>
                                    
                                    <div class="horoscope-container">
                                        <hr>
                                        <div style="text-align: center;">
                                            <span>以下から占いたい項目を選んでください。<br>AI占星術師アオポンがあなたのホロスコープから占います。</span>
                                        </div>
                                        <hr>
                                        <!-- 占いボタン群 -->
                                        <div class="analysis-buttons">
                                        <div class="analysis-button">
                                            <button type="submit" id="submit-button7">二人の相性</button>
                                            <div id="spinner7" class="spinner"></div>
                                        </div>
                                        <div class="analysis-button">
                                            <button type="submit" id="submit-button8">二人の今後</button>
                                            <div id="spinner8" class="spinner"></div>
                                        </div>
                                        </div>
                                    </div>
                                    <small>※AIがその都度鑑定を行うため、30秒~3分ほどかかります。</small>
                                    
                                    <!-- 占い結果表示 -->
                                    <div id="result">AIの回答がここに表示されます</div>
                                    
                                    <hr>
                                    <div id="ad-banner">
                                        <div class="desktop-ad">
                                            <a href="https://px.a8.net/svt/ejp?a8mat=44YP7H+8KELOI+2PEO+C4LLD" rel="nofollow">
                                            <img border="0" width="300" height="250" alt="" src="https://www29.a8.net/svt/bgt?aid=250202141518&wid=003&eno=01&mid=s00000012624002037000&mc=1"></a>
                                            <img border="0" width="1" height="1" src="https://www12.a8.net/0.gif?a8mat=44YP7H+8KELOI+2PEO+C4LLD" alt="">
                                            <a href="https://px.a8.net/svt/ejp?a8mat=44YP7H+D15N0I+2PEO+1BRTKX" rel="nofollow">
                                            <img border="0" width="300" height="250" alt="" src="https://www21.a8.net/svt/bgt?aid=250202141788&wid=003&eno=01&mid=s00000012624008024000&mc=1"></a>
                                            <img border="0" width="1" height="1" src="https://www16.a8.net/0.gif?a8mat=44YP7H+D15N0I+2PEO+1BRTKX" alt="">
                                        </div>
                                        <div class="mobile-ad">
                                            <a href="https://px.a8.net/svt/ejp?a8mat=44YP7H+8KELOI+2PEO+C4LLD" rel="nofollow">
                                            <img border="0" width="300" height="250" alt="" src="https://www29.a8.net/svt/bgt?aid=250202141518&wid=003&eno=01&mid=s00000012624002037000&mc=1"></a>
                                            <img border="0" width="1" height="1" src="https://www12.a8.net/0.gif?a8mat=44YP7H+8KELOI+2PEO+C4LLD" alt="">
                                            <a href="https://px.a8.net/svt/ejp?a8mat=44YP7H+D15N0I+2PEO+1BRTKX" rel="nofollow">
                                            <img border="0" width="300" height="250" alt="" src="https://www21.a8.net/svt/bgt?aid=250202141788&wid=003&eno=01&mid=s00000012624008024000&mc=1"></a>
                                            <img border="0" width="1" height="1" src="https://www16.a8.net/0.gif?a8mat=44YP7H+D15N0I+2PEO+1BRTKX" alt="">
                                        </div>
                                    </div>
                                    <br>
                                    <br>
                                    <hr>
                                    <a id="howtouse"></a>
                                    <div>
                                        <h3>このサイトの利用方法</h3>
                                        <div>
                                            <p>1.占いたい人の生年月日、出生時刻、出生地を入力します。（出生時刻が分からない場合は不明にチェックを入れてください。）</p>
                                            <p>2.ホロスコープを作成ボタンからホロスコープを作成できます。</p>
                                            <p>3.ホロスコープの詳細を見たい場合は、ホロスコープの詳細ボタンを押してください。大きなホロスコープを見ることができます。</p>
                                            <p>4.その後、占いたい項目(相性、今後)を2つのボタンから選択してください。</p>
                                            <p>5.ボタンを押すとAIが<strong>惑星の配置だけに基づいて</strong>、解析結果を占ってくれます。</p>
                                            <p>この解析結果の作成にはOpenAIのAPIを利用しています。</p>
                                        </div>
                                    </div>
                                    <div id="ad-banner">
                                        <div class="desktop-ad">
                                            <a href="https://px.a8.net/svt/ejp?a8mat=44YQRN+25EEYQ+7JY+U6W35" rel="nofollow">
                                            <img border="0" width="300" height="250" alt="" src="https://www25.a8.net/svt/bgt?aid=250204163130&wid=003&eno=01&mid=s00000000979005071000&mc=1"></a>
                                            <img border="0" width="1" height="1" src="https://www19.a8.net/0.gif?a8mat=44YQRN+25EEYQ+7JY+U6W35" alt="">
                                            <a href="https://px.a8.net/svt/ejp?a8mat=44YPZF+3I7YKI+2QD4+BXIYP" rel="nofollow">
                                            <img border="0" width="300" height="250" alt="" src="https://www29.a8.net/svt/bgt?aid=250203147212&wid=003&eno=01&mid=s00000012748002004000&mc=1"></a>
                                            <img border="0" width="1" height="1" src="https://www11.a8.net/0.gif?a8mat=44YPZF+3I7YKI+2QD4+BXIYP" alt="">
                                        </div>
                                        <div class="mobile-ad">
                                            <a href="https://px.a8.net/svt/ejp?a8mat=44YQRN+25EEYQ+7JY+U6W35" rel="nofollow">
                                            <img border="0" width="300" height="250" alt="" src="https://www25.a8.net/svt/bgt?aid=250204163130&wid=003&eno=01&mid=s00000000979005071000&mc=1"></a>
                                            <img border="0" width="1" height="1" src="https://www19.a8.net/0.gif?a8mat=44YQRN+25EEYQ+7JY+U6W35" alt="">
                                            <a href="https://px.a8.net/svt/ejp?a8mat=44YPZF+3I7YKI+2QD4+BXIYP" rel="nofollow">
                                            <img border="0" width="300" height="250" alt="" src="https://www29.a8.net/svt/bgt?aid=250203147212&wid=003&eno=01&mid=s00000012748002004000&mc=1"></a>
                                            <img border="0" width="1" height="1" src="https://www11.a8.net/0.gif?a8mat=44YPZF+3I7YKI+2QD4+BXIYP" alt="">
                                        </div>
                                    </div>
                                    <br>
                                    <br>
                                    <a id="horoscope-sample"></a>
                                    <hr>
                                    <div>
                                        <h3>ホロスコープのサンプル（大谷翔平さんの奥さんの真美子夫人）</h3>
                                        <div>
                                            <p>以下に例として1996/12/11 東京都生まれの大谷翔平さんの奥さんの真美子夫人のホロスコープのサンプルを表示します。</p>
                                        </div>
                                        <div style="text-align: center;">
                                            <img src="{% static 'path/to/horoscope-mamiko.png' %}" alt="horoscope demo image">
                                        </div>
                                    </div>
                                    <br>
                                    <br>
                                    <a id="analysis-sample1"></a>
                                    <hr>
                                    <div>
                                        <h3>AIによる分析結果のサンプル（大谷翔平さんと真美子夫人）二人の相性</h3>
                                        <div>
                                            <p>同様に例として大谷翔平さんと真美子夫人の二人の相性を占った結果を載せます。</p>
                                            <p>このように分かりやすい解析結果が得られます。</p>
                                            <p>「非常に魅力的で成長を促すパートナーシップが実現できる」という点なんかはイメージどおりのように思えます。</p>
                                        </div>
                                    </div>
                                    <div id="result-sample1" class="result-sample">
                                        <p>以下は、双方のパーソナルプラネット（太陽・月・水星・金星・火星など）を中心に、相性の傾向を読み解いた見解です。なお、お相手の出生時刻が不明なため、ハウスやアセンダント・MCの情報は利用せず、主に各自の内面的エネルギーと個性、そしてご両者の主要な配置の調和・緊張関係から判断しています。</p>
                                        <p>■【知性とコミュニケーション】<br>あなたのチャートでは、月・水星・火星が双子座にあり、知的でフレキシブルなコミュニケーションスタイルが際立っています。一方、お相手は太陽と月が射手座に位置しており、広い視野と冒険心、理想主義を持っています。双子座と射手座は互いに正反対の性質を持つため、「異なる視点から学び合う」という面では非常に刺激的な関係となる可能性があります。お互いの話題の広がりや情報収集、議論から新たな発見をもたらし、知的な刺激を享受できるでしょう。ただし、双子の細やかな情報処理と、射手の大局観との間で、時にすれ違いやコミュニケーションのズレが生じることも考えられます。</p>
                                        <p>■【感情の表現と愛情のスタイル】<br>あなたの太陽が蟹座にあるため、内面的な安心感や家族的、保護的な側面が強調され、恋愛においても感情的なつながりや安心感を求める傾向があります。一方で、あなたの金星は獅子座にあり、ドラマティックで自己表現豊かな愛情スタイルを示します。これに対し、お相手は金星が蠍座にあり、情熱的かつ奥深い愛情表現、時には独占欲も感じさせる傾向が見られます。獅子と蠍はともに固定的なエネルギーを持ち、深い情熱で互いに惹かれ合う可能性は大きいですが、一方で自尊心やコントロールの感覚から衝突が生じやすい面もあります。互いに強い個性を表現するため、相手の愛情表現や要求に対して理解と思いやりを持つことが鍵となりそうです。</p>
                                        <p>■【行動力と意志の衝突】<br>あなたの火星は双子座にあり、好奇心旺盛で情報交換を通じてエネルギーを発散する傾向があります。対して、お相手の火星は乙女座に位置し、実務的で細部にこだわる行動力を持っています。両者はアプローチの方法やスピード感が異なるため、共同作業や協力の場面で意見の食い違いが生じる可能性があります。しかし、火星が示すエネルギーが違う形で補い合えるならば、互いの強みを認めることでバランスが取れるでしょう。</p>
                                        <p>■【内面的成長と価値観の融合】<br>あなたの内面的な世界は、蟹座や水星・月が示す柔らかい感受性と知的柔軟性によって、心の安定と多面的な見方を持っています。お相手は射手座の明るさと、金星・木星・海王星が示す現実の厳しさや理想主義を合わせ持ち、人生を大局的に捉える傾向があります。たとえば、あなたの太陽（蟹座）が示す心の温かさと、お相手の射手座の冒険心が、互いの視野を広げ、内面的な成長を促す相乗効果をもたらすことが期待されます。</p>
                                        <p>■【注意点と相互理解】<br>・コミュニケーションの違い: 双子座と射手座は対極の関係であり、細やかな情報のやりとりと大局的な哲学がぶつかることもあります。お互いのアプローチの違いを認め合い、共通の興味や理想を見つける努力が必要です。<br>・愛情表現の熱さ: あなたの獅子（金星）とお相手の蠍（金星）は共に強い意志と情熱を示しますが、場合によっては相手に対する要求が強く出てしまう可能性があります。お互いのプライドや独自性を尊重し、妥協点を見つけることが望まれます。<br>・行動と態度の差異: あなたの柔軟な発想とお相手の実際的な行動スタイルは、時に調整が必要となります。お互いの強みを補い合う視点を持つと、相違点はむしろ良い刺激と成り得るでしょう。</p>
                                        <p>■【総合的な見解】<br>全体として、この組み合わせは、知的で刺激的なコミュニケーションと、深い情熱による感情的なつながりをもたらす可能性が高いです。相手の広い視野や冒険心が、あなたの多角的な思考や感受性と合わさることで、お互いに成長を促す関係が築けるでしょう。しかし、同時に価値観やアプローチの違いから摩擦が生じるリスクもありますので、柔軟さと相手への理解、さらには自分自身の内面のバランスを保つことが大切です。</p>
                                        <p>このように、双方が自分とは異なる考え方や感情表現のスタイルを受け入れ、共に歩む意志があれば、非常に魅力的で成長を促すパートナーシップが実現できると考えられます。</p>
                                    </div>
                                    
                                    <br>
                                    <br>
                                    <a id="analysis-sample2"></a>
                                    <hr>
                                    <div>
                                        <h3>AIによる分析結果のサンプル（大谷翔平さんと真美子夫人）二人の今後</h3>
                                        <div>
                                            <p>続けて例として大谷翔平さんの仕事運を占った結果を載せます。</p>
                                            <p>このように分かりやすい解析結果が得られます。</p>
                                            <p>「火と水の濃密なミックスとして、互いに引かれ合いやすい配置です。」という点が印象に残りました。</p>
                                        </div>
                                    </div>

                                    <div  id="result-sample2" class="result-sample">
                                        <p>以下のチャートから見ると、お二人の関係は、相反する部分と魅力的な引力が同居する、熱くも繊細なダイナミクスを持つ可能性が高いと考えられます。なお、お相手の出生時刻が不明なため、ハウスやアセンダント、MCの解釈は省いて、惑星のサインや主要なアスペクト、エネルギーの傾向を軸に解説いたします。</p>
                                        <p>【お互いの個性とエネルギーの違い】<br>・あなたは、蟹座の太陽を持っており、感情面や家庭的な安心感を重視される傾向があります。一方、パートナーは射手座の太陽・月を持ち、自由や冒険、知的な探究心、前向きなエネルギーで自己表現を行うタイプです。こうした違いは、基盤となる価値観において「家庭的な安心感」と「自由な探究心」の両極として表れ、互いの魅力となると同時に、折り合いをつけるための課題ともなり得ます。</p>
                                        <p>【恋愛・情愛面の絡み】<br>・あなたの金星は獅子座にあり、情熱的で自己表現豊かな愛情を示します。対して、パートナーの金星は蠍座にあり、恋愛においては深い情熱と時に独占欲や内面の激しさも含む表現となります。この組み合わせは、一見対極に感じられるものの、火と水の濃密なミックスとして、互いに引かれ合いやすい配置です。最初は互いの「表現する愛情」に魅了され、強い引力で結ばれる一方、深みに入るほど感情の対立や誤解が生じやすく、双方が相手の違いを尊重し、受容する努力が求められます。</p>
                                        <p>【コミュニケーションと知的交流】<br>・あなたは双子座の月・水星、そして火星も双子座と、言葉や情報交換、コミュニケーション面で機敏かつ軽快なエネルギーを持っています。これに対して、パートナーは射手座の月や太陽を中心とした、やや大局的で広い視野の持ち主。双方とも「知的好奇心」を刺激し合える配置ですが、あなたは細やかさや繊細な感受性、パートナーは大きなテーマを扱う傾向があるため、話題選びや表現方法においてすれ違いが生じる可能性もあります。互いに対話の中で相手のバックグラウンドや価値観を理解しようとする姿勢が、今後の発展の鍵となるでしょう。</p>
                                        <p>【安定性と刺激のバランス】<br>・あなたのチャートには、太陽が土星とトラインを形成している点から、自己の安定感や責任感、成熟した姿勢が感じられます。安定感をもって相手との関係を築くことができる一方、火星が天王星とトラインしているため、刺激的で新しい方向へと変革を促すエネルギーも内包しています。パートナー側も、射手座で広い視野を持ちながら、金星や海王星、さらには複数のセクスタイル・トラインの配置から、情熱と理想、そして変化に柔軟に対応する資質が見受けられます。こうした両者のバランスは、熱いロマンスとともに互いに成長を促す関係性へと発展する可能性があります。</p>
                                        <p>【挑戦点と成長の可能性】<br>・一方で、お互いの基盤となるエネルギーにおいて、あなたの内向的で安心感を求める面と、パートナーの自由奔放で冒険を求める面との間に、時として価値観の違いや、情緒面のズレが浮上するかもしれません。特に、パートナーの射手座太陽・月は、束縛や過度な依存を嫌います。対して、あなたは家庭や心の安定を大切にするため、相手の自由さと自身の求める安心感との間に緊張が生じる場面が考えられます。そうした状況では、どちらも譲歩や互いに歩み寄る努力、そしてコミュニケーションが重要となるでしょう。</p>
                                        <p>【総合的な見解】<br>お二人の今後は、互いに補い合うポテンシャルを秘めつつ、個々の違いが際立ってくる局面も訪れると考えられます。関係は、一方では情熱的で深いつながりを感じ、かつ知的にも精神的にも刺激し合える素晴らしいパートナーシップとなる可能性があります。しかし、その一方で、感情の求める方向や自己表現の仕方における大きな違いが、時として摩擦や誤解を生む要因ともなり得ます。</p>
                                        <p>お互いの違いを認め合い、相手の自由さと自分の安心を大切にする姿勢を持ち続けるなら、関係は次第に成熟し、双方にとって成長の場となるでしょう。また、安定感と刺激のバランスを意識することで、真摯な対話や共通の目標に対して協力し合う関係に進展することが期待されます。</p>
                                        <p>以上のように、今後のお二人の関係は、互いの魅力に惹かれ合いながらも、時には価値観の違いが浮き彫りになる、熱くも成長を促すパートナーシップへと発展していくと考えられます。忍耐強いコミュニケーションと双方の歩み寄りが、未来をより明るく豊かなものに導く鍵となるでしょう。</p>
                                    </div>
                                    <br>
                                    <br>
                                    <a id="horoscope-meaning"></a>
                                    <hr>
                                    <div>
                                        <div class="horoscope-meaning">
                                            <h3>コラム</h3>
                                            <h3>ホロスコープの意味するところ：天体が映し出すあなた自身の物語</h3>

                                            <p>占星術は、太古の昔から星々の運行を通じて人間の営みを読み解こうとしてきました。</p>
                                            <p>現代においても、ホロスコープは単なる未来予測の道具ではなく、自己理解と人生の指針を与えてくれる大切なコンパスとなっています。</p>
                                            <p>ここでは、ホロスコープが意味するところについて、その深い背景と実践的な意義を探ってみたいと思います。</p>
                                            <br>

                                            <h4>1. 天体の配置が示す「宇宙との対話」</h4>
                                            <p>ホロスコープは、誕生の瞬間における天体の位置を基に作成されます。太陽、月、惑星、アセンダントといった天体の配置は、個々の性格、才能、潜在的な課題や人生のテーマを象徴するとされています。これらは、宇宙があなたに与えた「プログラム」のようなものであり、どの天体がどの星座に位置しているか、またその天体同士がどのようなアスペクト（角度）を形成しているかは、あなたの内面世界や外部との関係性を映し出す鏡です。</p>
                                            <br>
                                            <h4>2. ホロスコープは未来を予言するのではなく、内面への気づきを促す</h4>
                                            <p>よく誤解される点として、ホロスコープは「運命を決定する未来予知ツール」というイメージがあります。しかし、占星術の真髄は、あくまで自己理解と成長のためのガイドラインにあります。天体の動きは、あくまであなたが持つ可能性や傾向を示すものであり、未来は常に変化しうるものです。ホロスコープは、どんな困難な時も「内面に目を向け、自己改革を促すチャンス」として活用することで、より充実した人生を歩むためのヒントとなります。</p>
                                            <br>
                                            <h4>3. 各天体と星座が語るあなたの物語</h4>
                                            <ul>
                                                <li>太陽は、あなたの中心的なエネルギーと本質を示し、ライフパーパス（生きる意味）に深く関わります。</li>
                                                <li>月は、内面の感情や無意識、心の反応を映し出し、情緒的な側面を理解する鍵となります。</li>
                                                <li>水星は、思考やコミュニケーションのスタイルを表し、知性や情報処理の在り方に光を当てます。</li>
                                                <li>金星は、愛情、価値観、美意識といった、心の豊かさに関連するテーマを象徴します。</li>
                                                <li>火星は、行動力や情熱、エネルギーの発散を示し、あなたがどのように目標に向かって突き進むかを描き出します。</li>
                                            </ul>
                                        
                                            <p>各惑星が属する星座は、その天体の性質に色を添え、どのような方法でそれらのエネルギーが表現されるかを示します。また、ハウス（宮）の位置は、天体が人生のどの分野に影響を及ぼすかを具体的に明らかにします。</p>
                                            <br>

                                            <h4>4. 自己理解への道しるべとしてのホロスコープ</h4>
                                            <p>ホロスコープは、自己探求の旅において大変貴重なツールです。例えば、苦難や試練の時期が訪れると、ホロスコープはその背景にある潜在的なパターンを読み解く助けとなります。そして、どのような課題に取り組むべきか、どの分野で成長が期待できるかといった、人生の「羅針盤」として活用することができるのです。</p>
                                            
                                            <p>また、ホロスコープは他者との関係性（シナストリー）を読み解くためにも利用されます。人間関係における相性や、互いのエネルギーがどのように交錯しているのかを知ることで、対人関係の改善や円滑なコミュニケーションに繋がります。</p>
                                            <br>
                                            <h4>5. 結びに</h4>
                                            <p>ホロスコープは、星々の神秘的な運行を通じてあなた自身の内面や人生のテーマを浮かび上がらせる、奥深い自己理解のツールです。決して未来を固定的に示すものではなく、あなたがどのように生き、どのように成長するかの可能性を示唆するガイドラインです。星々が紡ぐ物語に耳を傾け、その声に導かれながら、自分自身の本当の姿を見つけ出す旅に出てみてはいかがでしょうか。</p>
                                            
                                            <p>このコラムが、あなた自身のホロスコープに秘められた意味を探る一助となり、内なる光を見出すヒントとなることを願っています。</p>
                                        </div>
                                    </div>

                                </form>


                            </div>
                            
                            
                        </div>
                    </div>
                </main>
            </div> <!-- .layout-wrapper -->
            
        </div>


        <!-- (A) 時刻不明チェックボックスの自動処理 -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const timeInput = document.getElementById('time1');
                const unknownCheckbox = document.getElementById('unknown1');
            
                unknownCheckbox.addEventListener('change', function () {
                    if (this.checked) {
                        timeInput.value = '';
                    } else {
                        // timeInput.value = '';
                    }
                });
            });
            document.addEventListener('DOMContentLoaded', function () {
                const timeInput = document.getElementById('time2');
                const unknownCheckbox = document.getElementById('unknown2');
            
                unknownCheckbox.addEventListener('change', function () {
                    if (this.checked) {
                        timeInput.value = '';
                    } else {
                        // timeInput.value = '';
                    }
                });
            });
        </script>

        <!-- (C) クッキー周りのヘルパー関数 (必要な場合) -->
        <script>
            function setCookie(name, value, days) {
                const d = new Date();
                d.setTime(d.getTime() + (days*24*60*60*1000));
                const expires = "expires="+ d.toUTCString();
                document.cookie = `${name}=${value};${expires};path=/`;
            }
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        </script>

        <!-- (D) フォームの入力値をクッキーに保存＆復元 (必要に応じて) -->
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const yearSelect = document.getElementById('year-select1');
                const monthSelect = document.getElementById('month-select1');
                const daySelect = document.getElementById('day-select1');
                const timeInput = document.querySelector('input[name="time1"]');
                const prefectureSelect = document.getElementById('prefecture1');
                const checkboxSelect = document.getElementById('unknown1');

                // クッキーから読み込む例 (省略可)
                const savedYear = getCookie('horoscope_year1');
                const savedMonth = getCookie('horoscope_month1');
                const savedDay = getCookie('horoscope_day1');
                const savedTime = getCookie('horoscope_time1');
                const savedPrefecture = getCookie('horoscope_prefecture1');
                const savedCheckbox = getCookie('horoscope_checkbox1');

                if (yearSelect && savedYear) {
                    yearSelect.value = savedYear;
                }
                if (monthSelect && savedMonth) {
                    monthSelect.value = savedMonth;
                }
                if (daySelect && savedDay) {
                    daySelect.value = savedDay;
                }
                if (timeInput && savedTime !== null) {
                    timeInput.value = savedTime;
                }
                if (checkboxSelect && savedCheckbox !== null) {
                    checkboxSelect.checked = (savedCheckbox === 'true');
                }
                if (prefectureSelect && savedPrefecture) {
                    const options = prefectureSelect.options;
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].value === savedPrefecture) {
                            prefectureSelect.selectedIndex = i;
                            break;
                        }
                    }
                }

                // デフォルト値の設定（Cookieに該当値がない場合のみ）
                if (!savedYear || !savedMonth || !savedDay) {
                    const now = new Date();
                    if (yearSelect && !savedYear)  yearSelect.value  = now.getFullYear();
                    if (monthSelect && !savedMonth) monthSelect.value = String(now.getMonth() + 1);
                    if (daySelect && !savedDay)     daySelect.value   = String(now.getDate());
                }
                if (!savedTime && savedCheckbox == null) {
                    const now = new Date();
                    const hours   = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    if (timeInput) timeInput.value = `${hours}:${minutes}`;
                }
                // 都道府県切り替え
                if (prefectureSelect) {
                    function updateLatLon(e) {
                        const selected = e.target.selectedOptions[0];
                        document.getElementById('lat1').value = selected.getAttribute('data-lat');
                        document.getElementById('lon1').value = selected.getAttribute('data-lon');
                    }
                    // 初期化
                    const defaultSelected = prefectureSelect.selectedOptions[0];
                    document.getElementById('lat1').value = defaultSelected.getAttribute('data-lat');
                    document.getElementById('lon1').value = defaultSelected.getAttribute('data-lon');
                    // 変更イベント
                    prefectureSelect.addEventListener('change', updateLatLon);
                }
            });
            document.addEventListener('DOMContentLoaded', () => {
                const yearSelect = document.getElementById('year-select2');
                const monthSelect = document.getElementById('month-select2');
                const daySelect = document.getElementById('day-select2');
                const timeInput = document.querySelector('input[name="time2"]');
                const prefectureSelect = document.getElementById('prefecture2');
                const checkboxSelect = document.getElementById('unknown2');

                // クッキーから読み込む例 (省略可)
                const savedYear = getCookie('horoscope_year2');
                const savedMonth = getCookie('horoscope_month2');
                const savedDay = getCookie('horoscope_day2');
                const savedTime = getCookie('horoscope_time2');
                const savedPrefecture = getCookie('horoscope_prefecture2');
                const savedCheckbox = getCookie('horoscope_checkbox2');

                if (yearSelect && savedYear) {
                    yearSelect.value = savedYear;
                }
                if (monthSelect && savedMonth) {
                    monthSelect.value = savedMonth;
                }
                if (daySelect && savedDay) {
                    daySelect.value = savedDay;
                }
                if (timeInput && savedTime !== null) {
                    timeInput.value = savedTime;
                }
                if (checkboxSelect && savedCheckbox !== null) {
                    checkboxSelect.checked = (savedCheckbox === 'true');
                }
                if (prefectureSelect && savedPrefecture) {
                    const options = prefectureSelect.options;
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].value === savedPrefecture) {
                            prefectureSelect.selectedIndex = i;
                            break;
                        }
                    }
                }

                // デフォルト値の設定（Cookieに該当値がない場合のみ）
                if (!savedYear || !savedMonth || !savedDay) {
                    const now = new Date();
                    if (yearSelect && !savedYear)  yearSelect.value  = now.getFullYear();
                    if (monthSelect && !savedMonth) monthSelect.value = String(now.getMonth() + 1);
                    if (daySelect && !savedDay)     daySelect.value   = String(now.getDate());
                }
                if (!savedTime && savedCheckbox == null) {
                    const now = new Date();
                    const hours   = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    if (timeInput) timeInput.value = `${hours}:${minutes}`;
                }
                // 都道府県切り替え
                if (prefectureSelect) {
                    function updateLatLon(e) {
                        const selected = e.target.selectedOptions[0];
                        document.getElementById('lat2').value = selected.getAttribute('data-lat');
                        document.getElementById('lon2').value = selected.getAttribute('data-lon');
                    }
                    // 初期化
                    const defaultSelected = prefectureSelect.selectedOptions[0];
                    document.getElementById('lat2').value = defaultSelected.getAttribute('data-lat');
                    document.getElementById('lon2').value = defaultSelected.getAttribute('data-lon');
                    // 変更イベント
                    prefectureSelect.addEventListener('change', updateLatLon);
                }
            });
        </script>
        
        <!-- (E) フォーム送信（ボタンクリック）本番運用 -->
        <script>
            
            // Django等でCSRFトークンがセットされている想定
            const csrftoken = getCookie('csrftoken');
            
            // 送信ボタンの要素（例: 3つのボタン）
            const submitButtons = [
            document.getElementById('submit-button7'),
            document.getElementById('submit-button8')
            ];
            const resultDiv = document.getElementById('result');

            // フォームデータをオブジェクトに変換するヘルパー関数
            const formDataToObject = formData => {
                const data = {};
                formData.forEach((value, key) => data[key] = value);
                return data;
            };
            
            // クッキーに保存する関数
            function saveFormDataToCookies(formData) {
                const data = formDataToObject(formData);
                setCookie('horoscope_year1', data.year1, 30); // 30日間有効
                setCookie('horoscope_month1', data.month1, 30); // 30日間有効
                setCookie('horoscope_day1', data.day1, 30); // 30日間有効
                setCookie('horoscope_time1', data.time1, 30);
                setCookie('horoscope_prefecture1', data.prefecture1, 30);
                
                // チェックボックスの状態を 'true' または 'false' で保存
                const isChecked1 = formData.has('unknown1') ? 'true' : 'false';
                setCookie('horoscope_checkbox1', isChecked1, 30);


                setCookie('horoscope_year2', data.year2, 30); // 30日間有効
                setCookie('horoscope_month2', data.month2, 30); // 30日間有効
                setCookie('horoscope_day2', data.day2, 30); // 30日間有効
                setCookie('horoscope_time2', data.time2, 30);
                setCookie('horoscope_prefecture2', data.prefecture2, 30);
                
                // チェックボックスの状態を 'true' または 'false' で保存
                const isChecked2 = formData.has('unknown2') ? 'true' : 'false';
                setCookie('horoscope_checkbox2', isChecked2, 30);
            }
            
            // 送信ハンドラー生成関数
            const createSubmitHandler = (sbValue, spinnerId) => async e => {
                e.preventDefault();
                
                const form = e.target.form;
                if (!form) return;

                try {
                    // フォームデータ処理
                    const formData = new FormData(form);
                    const data = formDataToObject(formData);
                    
                    // 日付と時刻の分解
                    const year1 = data.year1;
                    const month1 = data.month1;
                    const day1 = data.day1;
                    const time1  = data.time1 || "12:00";
                    const [hour1, minute1] = time1.split(':');
                    const unknown1 = data.unknown1;
                    
                    const year2 = data.year2;
                    const month2 = data.month2;
                    const day2 = data.day2;
                    const time2  = data.time2 || "12:00";
                    const [hour2, minute2] = time2.split(':');
                    const unknown2 = data.unknown2;

                    // 送信データの組み立て
                    const sendData = {
                        year1: year1,
                        month1: month1,
                        day1: day1,
                        hour1: hour1,
                        minute1: minute1,
                        lat1: data.lat1,
                        lon1: data.lon1,
                        tz1: data.tz1,
                        dst1: data.dst1,
                        unknown1: unknown1,
                        year2: year2,
                        month2: month2,
                        day2: day2,
                        hour2: hour2,
                        minute2: minute2,
                        lat2: data.lat2,
                        lon2: data.lon2,
                        tz2: data.tz2,
                        dst2: data.dst2,
                        unknown2: unknown2,
                        sb: sbValue
                    };

                    // UI状態更新
                    submitButtons.forEach(btn => btn.disabled = true);
                    const spinner = document.getElementById(spinnerId);
                    if (spinner) spinner.style.display = 'inline-block';

                    // APIリクエスト
                    const response = await fetch("{% url 'horoscope_app:analyze_compatibility' %}", {
                    method: 'POST',
                    credentials: 'same-origin',  // これを追加
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrftoken
                    },
                    body: new URLSearchParams(sendData)
                    });

                    // レスポンス処理
                    const content = await response.json();
                    if (!response.ok) throw new Error(content.error || 'Unknown error');

                    // Markdown処理とサニタイズ
                    const cleanHtml = DOMPurify.sanitize(marked.parse(content.result));
                    resultDiv.innerHTML = cleanHtml;

                    // クッキーに保存
                    saveFormDataToCookies(formData);

                } catch (error) {
                    const errorMessage = error.name === 'SyntaxError' 
                    ? 'Invalid server response'
                    : error.message;
                    resultDiv.textContent = error.response ?
                     `エラー: ${error.message}` 
                    : `通信エラー: ${errorMessage}`;
                } finally {
                    submitButtons.forEach(btn => btn.disabled = false);
                    const spinner = document.getElementById(spinnerId);
                    if (spinner) spinner.style.display = 'none';
                }
            };

            // ボタン設定とイベントリスナーの登録
            const buttonConfigs = [
            { id: 'submit-button7', spinner: 'spinner7', sb: 7 },
            { id: 'submit-button8', spinner: 'spinner8', sb: 8 }
            ];

            buttonConfigs.forEach(({ id, spinner, sb }) => {
            const button = document.getElementById(id);
            if (button) {
                button.addEventListener('click', createSubmitHandler(sb, spinner));
            }
            });
        </script>

        <!-- (F) ホロスコープを生成・描画するスクリプト -->
        <script>
            // 惑星英名 => 惑星和名
            const planetNameMap = {
                "Sun"     : "太陽",
                "Moon"    : "月",
                "Mercury" : "水星",
                "Venus"   : "金星",
                "Mars"    : "火星",
                "Jupiter" : "木星",
                "Saturn"  : "土星",
                "Uranus"  : "天王星",
                "Neptune" : "海王星",
                "Pluto"   : "冥王星"
            };
            // 惑星英名 => シンボル
            const planetSymbolMap = {
                "Sun"     : "☉",
                "Moon"    : "☾",
                "Mercury" : "☿",
                "Venus"   : "♀",
                "Mars"    : "♂",
                "Jupiter" : "♃",
                "Saturn"  : "♄",
                "Uranus"  : "♅",
                "Neptune" : "♆",
                "Pluto"   : "♇"
            };
            // アスペクト色（高級感のある金・銀・深紅・濃緑・ダークゴールド）
            const aspectColorMap = {
                "コンジャンクション": "#FFD700",  // 明るいゴールド（ゴールド）
                "オポジション": "#0000FF",        // ブルー（青）
                "スクエア": "#FF6347",            // 明るいレッド（トマトレッド）
                "トライン": "#32CD32",            // 明るいグリーン（ライムグリーン）
                "セクスタイル": "#FFCC33",        // 明るいゴールデンロッド（ライトゴールデンロッド）
                "Conjunction": "#FFD700",
                "Opposition": "#0000FF",
                "Square": "#FF6347",
                "Trine": "#32CD32",
                "Sextile": "#FFCC33"
            };
            // 星座のシンボル
            const zodiacSymbols = {
                0: "♈", 1: "♉", 2: "♊", 3: "♋",
                4: "♌", 5: "♍", 6: "♎", 7: "♏",
                8: "♐", 9: "♑", 10: "♒", 11: "♓"
            };

            /**
             * ホロスコープを描画する関数
             * @param {Object} horoscopeData サーバー等から取得したホロスコープ情報
             */
            function drawHoroscopeWheel(horoscopeData, name1, name2) {
                const chartContainer = document.getElementById(name1);
                const canvas = document.getElementById(name2);

                // canvas のサイズ調整
                let containerWidth = chartContainer.offsetWidth; 
                if (containerWidth > 300) {
                    containerWidth = 300; 
                }
                canvas.width = containerWidth;
                canvas.height = containerWidth;
                chartContainer.style.width  = containerWidth + "px";
                chartContainer.style.height = containerWidth + "px";

                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius  = canvas.width * 0.4;

                // ハウスデータの処理（rotationOffset 等）
                const houseData = horoscopeData?.raw_data?.houses;
                let rotationOffset = 0;
                if (houseData && houseData.cusp && houseData.cusp.length > 0) {
                    const firstCuspDeg = houseData.cusp[0];
                    rotationOffset = (90 - firstCuspDeg) % 360;
                }
                function degToRad(deg) {
                    return (360 - (deg + rotationOffset) - 90) * Math.PI / 180;
                }

                // 背景グラデーション（中心から薄い青がかかるグラデーション）
                const bgGradient = ctx.createRadialGradient(
                    centerX, centerY, 0,
                    centerX, centerY, radius * 1.5
                );
                bgGradient.addColorStop(0,   "#f0f8ff");
                bgGradient.addColorStop(0.7, "#cceeff");
                bgGradient.addColorStop(1,   "#99bbff");
                ctx.fillStyle = bgGradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // 外円描画（ゴールドの外枠）
                ctx.save();
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius + 10, 0, 2 * Math.PI);
                ctx.shadowColor = 'rgba(30, 144, 255, 0.5)'; // 濃い青色のシャドウ
                ctx.shadowBlur = 10;
                ctx.strokeStyle = '#E0FFFF'; // プラチナシルバー
                ctx.lineWidth = 4;
                ctx.stroke();
                ctx.restore();

                // ハウス線とハウス番号（ハウス番号の色を黒に変更）
                if (houseData && houseData.cusp) {
                    for (let i = 0; i < houseData.cusp.length; i++) {
                        const cuspAngleDeg = houseData.cusp[i];
                        const angleRad = degToRad(cuspAngleDeg);

                        const x2 = centerX + (radius + 10) * Math.cos(angleRad);
                        const y2 = centerY + (radius + 10) * Math.sin(angleRad);

                        ctx.save();
                        ctx.beginPath();
                        ctx.moveTo(centerX, centerY);
                        ctx.lineTo(x2, y2);
                        ctx.strokeStyle = 'rgba(0, 0, 0, 0.5)'; // 黒
                        ctx.lineWidth = 1;
                        ctx.setLineDash([6, 4]); // 点線
                        ctx.stroke();
                        ctx.restore();

                        // ハウス番号を白で描画
                        const labelRadius = radius * 0.5;
                        const labelX = centerX + labelRadius * Math.cos(angleRad - 0.26);
                        const labelY = centerY + labelRadius * Math.sin(angleRad - 0.26);

                        ctx.save();
                        ctx.font = Math.floor(canvas.width * 0.025) + "px 'Times New Roman'";
                        ctx.fillStyle = "#000000"; // 黒
                        ctx.textAlign = "center";
                        ctx.textBaseline = "middle";
                        ctx.fillText((i + 1).toString(), labelX, labelY);
                        ctx.restore();
                    }
                }

                // ★ 惑星配置
                const planets = horoscopeData?.raw_data?.planets;
                if (!planets) {
                    alert("惑星データが見つかりません。");
                    return;
                }
                const planetPositions = {};
                // drawnSymbols 配列は adjust 関数用（シンボル位置の調整用）
                const drawnSymbols = [];
                // planetSymbolsToDraw 配列にシンボル描画情報を保存し、後で最前面に描画する
                const planetSymbolsToDraw = [];

                /**
                 * adjust 関数
                 * 惑星シンボル同士が重なっている場合、元の位置から offset ずらした位置を返し、
                 * その位置と元の位置を線分で結びます。
                 *
                 * @param {CanvasRenderingContext2D} ctx - canvas のコンテキスト
                 * @param {number} x - 元の x 座標
                 * @param {number} y - 元の y 座標
                 * @param {number} angle - 惑星配置の角度 (ラジアン)
                 * @param {Array} drawnSymbols - 既に描画済みのシンボルの位置リスト
                 * @returns {Object} 調整後の {x, y} 座標
                 */
                function adjust(ctx, x, y, angle, drawnSymbols) {
                    const offsetStep = 30;         // 30px ずつずらす
                    let offset = 0;
                    let newX = x;
                    let newY = y;
                    const collisionThreshold = 15; // 中心間距離が15px未満なら重なっていると判定

                    while (true) {
                        let collision = false;
                        for (let pos of drawnSymbols) {
                            const dx = pos.x - newX;
                            const dy = pos.y - newY;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            if (distance < collisionThreshold) {
                                collision = true;
                                break;
                            }
                        }
                        if (!collision) {
                            break;
                        }
                        offset += offsetStep;
                        newX = x - offset * Math.cos(angle);
                        newY = y - offset * Math.sin(angle);
                        // 無限ループ防止のための上限
                        if (offset > 100) break;
                    }

                    // ずらしが発生していた場合、元の位置と調整後の位置を線分で結ぶ
                    if (offset > 0) {
                        ctx.save();
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        ctx.lineTo(newX, newY);
                        ctx.strokeStyle = "rgba(255,255,255,0.5)";
                        ctx.lineWidth = 0.5;
                        ctx.stroke();
                        ctx.restore();
                    }
                    drawnSymbols.push({ x: newX, y: newY });
                    return { x: newX, y: newY };
                }

                // 各惑星の描画（惑星の円はそのまま描く）
                for (const planetName of Object.keys(planets)) {
                    const planetObj = planets[planetName];
                    if (planetObj.longitude === undefined) continue;
                    
                    let lonDeg = Array.isArray(planetObj.longitude)
                        ? planetObj.longitude[0]
                        : parseFloat(planetObj.longitude);
                    if (isNaN(lonDeg)) continue;
                    
                    const angleRad = degToRad(lonDeg);
                    const x = centerX + radius * Math.cos(angleRad);
                    const y = centerY + radius * Math.sin(angleRad);

                    // 惑星の円を描画（高級感のある色合い）
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(x, y, canvas.width * 0.008, 0, 2 * Math.PI);
                    let fillColor = '#dd3333';
                    switch (planetName) {
                        case 'Sun'     : fillColor = '#D4AF37'; break;  // ゴールド
                        case 'Moon'    : fillColor = '#C0C0C0'; break;  // シルバー
                        case 'Mercury' : fillColor = '#708090'; break;  // スレートグレー
                        case 'Venus'   : fillColor = '#B87333'; break;  // カッパー
                        case 'Mars'    : fillColor = '#8B0000'; break;  // ダークレッド
                        case 'Jupiter' : fillColor = '#CD7F32'; break;  // ブロンズ
                        case 'Saturn'  : fillColor = '#A67B5B'; break;  // ブロンズ系
                        case 'Uranus'  : fillColor = '#008080'; break;  // ティール
                        case 'Neptune' : fillColor = '#00008B'; break;  // ネイビー
                        case 'Pluto'   : fillColor = '#800080'; break;  // パープル
                    }
                    ctx.fillStyle = fillColor;
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.3)'; // 黒色のシャドウ
                    ctx.shadowBlur = 6;
                    ctx.fill();
                    ctx.restore();

                    // adjust 関数でシンボルの位置を調整（重なりがあれば線分も描画）
                    const symbol = planetSymbolMap[planetName] || planetName;
                    const adjustedPos = adjust(ctx, x, y, angleRad, drawnSymbols);
                    // ※ 惑星シンボルは黒で描画（fillStyle を "#000000" に変更）
                    planetSymbolsToDraw.push({
                        symbol: symbol,
                        x: adjustedPos.x,
                        y: adjustedPos.y,
                        font: Math.floor(canvas.width * 0.08) + "px sans-serif",
                        fillStyle: "#000000" // 黒
                    });

                    planetPositions[planetName] = { x, y };
                }

                // アスペクト描画
                const aspects = horoscopeData?.analysis?.["4.アスペクトの結果"] || [];
                aspects.forEach(aspect => {
                    const planet1Ja = aspect.planet1;
                    const planet2Ja = aspect.planet2;
                    const aspectName = aspect.aspect;
                    let p1En = null, p2En = null;
                    for (const [en, ja] of Object.entries(planetNameMap)) {
                        if (ja === planet1Ja) p1En = en;
                        if (ja === planet2Ja) p2En = en;
                    }
                    if (!p1En || !p2En) return;

                    const pos1 = planetPositions[p1En];
                    const pos2 = planetPositions[p2En];
                    if (!pos1 || !pos2) return;

                    let lineColor = aspectColorMap[aspectName] || "#AAAAAA"; // パステル調の色

                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(pos1.x, pos1.y);
                    ctx.lineTo(pos2.x, pos2.y);
                    ctx.strokeStyle = lineColor;
                    ctx.lineWidth = canvas.width * 0.002;
                    if (aspectName === "スクエア" || aspectName === "Square") {
                        ctx.setLineDash([5, 3]);
                    }
                    ctx.stroke();
                    ctx.restore();
                });

                const zodiacColors = [
                    "#FF0000", // Red (牡羊座)
                    "#808000", // Dark Yellow (牡牛座)　
                    "#008000", // Green (双子座)
                    "#0000FF", // Blue (蟹座)
                    "#FF0000", // Red (獅子座)
                    "#808000", // Dark Yellow (乙女座)　
                    "#008000", // Green (天秤座)
                    "#0000FF", // Blue (蠍座)
                    "#FF0000", // Red (射手座)
                    "#808000", // Dark Yellow (山羊座)　
                    "#008000", // Green (水瓶座)
                    "#0000FF", // Blue (魚座)
                ];

                // ★ 星座の区分線およびシンボルの描画（修正版）
                ctx.save();
                // 内側のホロスコープ円（radius）はそのまま利用
                // 内側の区分線の開始位置（ホロスコープ円から少し外側）
                const innerDividingRadius = radius + (canvas.width * 0.017);
                // 星座シンボルを描く半径（内側と外側の中間あたり）
                const zodiacSymbolRadius = radius + (canvas.width * 0.06);
                // 外側に描く大きな円の半径（星座シンボルの外側＋余白）
                const outerCircleRadius = zodiacSymbolRadius + (canvas.width * 0.03);
                
                for (let i = 0; i < 12; i++) {
                    // degToRad が反転しているので、開始角度と終了角度を入れ替えています
                    const startAngle = degToRad((i + 1) * 30);
                    const endAngle   = degToRad(i * 30);

                    ctx.beginPath();
                    // 外側円弧の開始点に移動
                    ctx.moveTo(
                        centerX + outerCircleRadius * Math.cos(startAngle),
                        centerY + outerCircleRadius * Math.sin(startAngle)
                    );
                    // 外側の円弧を描く（startAngle ～ endAngle）
                    ctx.arc(centerX, centerY, outerCircleRadius, startAngle, endAngle, false);
                    // 外側の円弧の終点と内側の円弧の開始点を直接結ぶ
                    ctx.lineTo(
                        centerX + innerDividingRadius * Math.cos(endAngle),
                        centerY + innerDividingRadius * Math.sin(endAngle)
                    );
                    // 内側の円弧を描く（endAngle ～ startAngle を逆方向に）
                    ctx.arc(centerX, centerY, innerDividingRadius, endAngle, startAngle, true);
                    // パスを閉じる（自動的に内側の円弧の終点と外側の円弧の開始点を結ぶ）
                    ctx.closePath();

                    // ctx.fillStyle = zodiacColors[i];
                    ctx.fill();
                }

                // ① 外側の大円の外周を描画（ゴールドのライン）
                ctx.beginPath();
                ctx.arc(centerX, centerY, outerCircleRadius, 0, 2 * Math.PI);
                ctx.strokeStyle = '#D4AF37';
                ctx.lineWidth = 4;
                ctx.stroke();

                // ② 星座区分線と星座シンボルの描画
                for (let i = 0; i < 12; i++) {
                    // 各星座の境界線の角度（0～360°）
                    const lineAngle = degToRad(i * 30);
                    // 区分線は内側（innerDividingRadius）から外側の大円（outerCircleRadius）まで
                    ctx.beginPath();
                    ctx.moveTo(
                        centerX + innerDividingRadius * Math.cos(lineAngle),
                        centerY + innerDividingRadius * Math.sin(lineAngle)
                    );
                    ctx.lineTo(
                        centerX + outerCircleRadius * Math.cos(lineAngle),
                        centerY + outerCircleRadius * Math.sin(lineAngle)
                    );
                    ctx.strokeStyle = "rgba(50, 50, 50, 0.8)"; // 濃いグレー
                    ctx.lineWidth = 1;
                    ctx.stroke();

                    // 星座シンボルは区分線の中央あたりに配置（色を黒に変更）
                    const midAngleRad = degToRad(i * 30 + 15);
                    // シンボルを配置する半径は内側と外側の中間
                    const symbolRadius = (innerDividingRadius + outerCircleRadius) / 2;
                    const textX = centerX + symbolRadius * Math.cos(midAngleRad);
                    const textY = centerY + symbolRadius * Math.sin(midAngleRad);

                    ctx.save();
                    ctx.translate(textX, textY);
                    ctx.font = Math.floor(canvas.width * 0.05) + "px 'Arial Rounded MT Bold'"; // Arial Rounded MT Bold風フォント
                    ctx.fillStyle = "#000000";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(zodiacSymbols[i], 0, 0);
                    ctx.restore();
                }
                ctx.restore();

                // ★ 最後に、保存しておいた惑星シンボルを再描画して最前面に表示（色を黒に変更）
                planetSymbolsToDraw.forEach(item => {
                    ctx.save();
                    ctx.font = item.font;
                    ctx.fillStyle = item.fillStyle;
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(item.symbol, item.x, item.y);
                    ctx.restore();
                });
            }
        </script>


        <!-- (G-1) 「ホロスコープを作成」ボタンの処理 (本番データで描画) -->
        <script>
            document.getElementById('draw-button1').addEventListener('click', async function() {
                // (1) フォームの入力からパラメータを生成
                const form = document.getElementById('horoscope-form');
                const formData = new FormData(form);
                const year  = formData.get('year1');
                const month = formData.get('month1');
                const day   = formData.get('day1');
                const time  = formData.get('time1') || "12:00";
                const lat   = formData.get('lat1');
                const lon   = formData.get('lon1');
                const tz    = formData.get('tz1');
                const dst   = formData.get('dst1');
    
                // 不明時刻の場合は hour, minute = '12:00' などで補正
                const [hour, minute] = time.split(':');
    
                // クエリパラメータを作成 (Django想定の例)
                const params = new URLSearchParams({
                    year, month, day,
                    hour, minute,
                    lat, lon,
                    tz, dst
                });
                // 例: /horoscope_app/horoscope/?year=...&month=... など
                // 実際のURLはサーバー側に合わせて修正してください
                const horoscopeUrl = "{% url 'horoscope_app:horoscope' %}?" + params.toString();
    
                // (2) fetch でサーバーからホロスコープデータを取得
                try {
                    const response = await fetch(horoscopeUrl, {
                        method: 'GET',
                    });
                    if (!response.ok) {
                        throw new Error("ホロスコープデータの取得に失敗しました");
                    }
    
                    const horoscopeData = await response.json();
    
                    // (3) モーダルを表示後、実際に描画
                    const chartContainer = document.getElementById('chart-container1');
                    chartContainer.style.display = 'block';
                    drawHoroscopeWheel(horoscopeData,'chart-container1','horoscope-canvas1');
                    saveFormDataToCookies(formData);
    
                } catch (err) {
                    alert(err.message);
                }
            });
        </script>
        <!-- (G2-1) 「ホロスコープを作成」の処理画面読み込み時 (本番データで描画) -->
        <script>
            document.addEventListener('DOMContentLoaded', async function() {
                // (1) フォームの入力からパラメータを生成
                const form = document.getElementById('horoscope-form');
                const formData = new FormData(form);
                const year  = formData.get('year1');
                const month = formData.get('month1');
                const day   = formData.get('day1');
                const time  = formData.get('time1') || "12:00";
                const lat   = formData.get('lat1');
                const lon   = formData.get('lon1');
                const tz    = formData.get('tz1');
                const dst   = formData.get('dst1');
    
                // 不明時刻の場合は hour, minute = '12:00' などで補正
                const [hour, minute] = time.split(':');
    
                // クエリパラメータを作成 (Django想定の例)
                const params = new URLSearchParams({
                    year, month, day,
                    hour, minute,
                    lat, lon,
                    tz, dst
                });
                // 例: /horoscope_app/horoscope/?year=...&month=... など
                // 実際のURLはサーバー側に合わせて修正してください
                const horoscopeUrl = "{% url 'horoscope_app:horoscope' %}?" + params.toString();
    
                // (2) fetch でサーバーからホロスコープデータを取得
                try {
                    const response = await fetch(horoscopeUrl, {
                        method: 'GET',
                    });
                    if (!response.ok) {
                        throw new Error("ホロスコープデータの取得に失敗しました");
                    }
    
                    const horoscopeData = await response.json();
    
                    // (3) モーダルを表示後、実際に描画
                    const chartContainer = document.getElementById('chart-container1');
                    chartContainer.style.display = 'block';
                    drawHoroscopeWheel(horoscopeData,'chart-container1','horoscope-canvas1');
                    saveFormDataToCookies(formData);
    
                } catch (err) {
                    alert(err.message);
                }
            });
        </script>
        <!-- (G-2) 「ホロスコープを作成」ボタンの処理 (本番データで描画) -->
        <script>
            document.getElementById('draw-button2').addEventListener('click', async function() {
                // (1) フォームの入力からパラメータを生成
                const form = document.getElementById('horoscope-form');
                const formData = new FormData(form);
                const year  = formData.get('year2');
                const month = formData.get('month2');
                const day   = formData.get('day2');
                const time  = formData.get('time2') || "12:00";
                const lat   = formData.get('lat2');
                const lon   = formData.get('lon2');
                const tz    = formData.get('tz2');
                const dst   = formData.get('dst2');
    
                // 不明時刻の場合は hour, minute = '12:00' などで補正
                const [hour, minute] = time.split(':');
    
                // クエリパラメータを作成 (Django想定の例)
                const params = new URLSearchParams({
                    year, month, day,
                    hour, minute,
                    lat, lon,
                    tz, dst
                });
                // 例: /horoscope_app/horoscope/?year=...&month=... など
                // 実際のURLはサーバー側に合わせて修正してください
                const horoscopeUrl = "{% url 'horoscope_app:horoscope' %}?" + params.toString();
    
                // (2) fetch でサーバーからホロスコープデータを取得
                try {
                    const response = await fetch(horoscopeUrl, {
                        method: 'GET',
                    });
                    if (!response.ok) {
                        throw new Error("ホロスコープデータの取得に失敗しました");
                    }
    
                    const horoscopeData = await response.json();
    
                    // (3) モーダルを表示後、実際に描画
                    const chartContainer = document.getElementById('chart-container2');
                    chartContainer.style.display = 'block';
                    drawHoroscopeWheel(horoscopeData,'chart-container2','horoscope-canvas2');
                    saveFormDataToCookies(formData);
    
                } catch (err) {
                    alert(err.message);
                }
            });
        </script>
        <!-- (G2-2) 「ホロスコープを作成」の処理画面読み込み時 (本番データで描画) -->
        <script>
            document.addEventListener('DOMContentLoaded', async function() {
                // (1) フォームの入力からパラメータを生成
                const form = document.getElementById('horoscope-form');
                const formData = new FormData(form);
                const year  = formData.get('year2');
                const month = formData.get('month2');
                const day   = formData.get('day2');
                const time  = formData.get('time2') || "12:00";
                const lat   = formData.get('lat2');
                const lon   = formData.get('lon2');
                const tz    = formData.get('tz2');
                const dst   = formData.get('dst2');
    
                // 不明時刻の場合は hour, minute = '12:00' などで補正
                const [hour, minute] = time.split(':');
    
                // クエリパラメータを作成 (Django想定の例)
                const params = new URLSearchParams({
                    year, month, day,
                    hour, minute,
                    lat, lon,
                    tz, dst
                });
                // 例: /horoscope_app/horoscope/?year=...&month=... など
                // 実際のURLはサーバー側に合わせて修正してください
                const horoscopeUrl = "{% url 'horoscope_app:horoscope' %}?" + params.toString();
    
                // (2) fetch でサーバーからホロスコープデータを取得
                try {
                    const response = await fetch(horoscopeUrl, {
                        method: 'GET',
                    });
                    if (!response.ok) {
                        throw new Error("ホロスコープデータの取得に失敗しました");
                    }
    
                    const horoscopeData = await response.json();
    
                    // (3) モーダルを表示後、実際に描画
                    const chartContainer = document.getElementById('chart-container2');
                    chartContainer.style.display = 'block';
                    drawHoroscopeWheel(horoscopeData,'chart-container2','horoscope-canvas2');
                    saveFormDataToCookies(formData);
    
                } catch (err) {
                    alert(err.message);
                }
            });
        </script>
        <!-- 詳細画面へリンク -->
        <script>
            document.getElementById('view-button1').addEventListener('click', function() {
            const form = document.getElementById('horoscope-form');
            const formData = new FormData(form);
            const year  = formData.get('year1');
            const month = formData.get('month1');
            const day   = formData.get('day1');
            const time  = formData.get('time1') || "12:00";
            const lat   = formData.get('lat1');
            const lon   = formData.get('lon1');
            const tz    = formData.get('tz1');
            const dst   = formData.get('dst1');
        
            const [hour, minute] = time.split(':');
        
            const params = new URLSearchParams({
                year, month, day,
                hour, minute,
                lat, lon,
                tz, dst
            });
            
            saveFormDataToCookies(formData);

            const horoscopeUrl = "{% url 'horoscope_app:horoscope_detail' %}?" + params.toString();
            window.location.href = horoscopeUrl;
            });
            document.getElementById('view-button2').addEventListener('click', function() {
            const form = document.getElementById('horoscope-form');
            const formData = new FormData(form);
            const year  = formData.get('year2');
            const month = formData.get('month2');
            const day   = formData.get('day2');
            const time  = formData.get('time2') || "12:00";
            const lat   = formData.get('lat2');
            const lon   = formData.get('lon2');
            const tz    = formData.get('tz2');
            const dst   = formData.get('dst2');
        
            const [hour, minute] = time.split(':');
        
            const params = new URLSearchParams({
                year, month, day,
                hour, minute,
                lat, lon,
                tz, dst
            });
            
            saveFormDataToCookies(formData);

            const horoscopeUrl = "{% url 'horoscope_app:horoscope_detail' %}?" + params.toString();
            window.location.href = horoscopeUrl;
            });
        </script>
    </body>
</html>
